<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tempahan Bas Pulang Bermalam</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>body{min-height:100vh} .small-btn{padding:.28rem .5rem;font-size:.8rem}</style>
</head>
<body class="bg-light">
    <div class="container py-3">
        <div class="bg-white rounded shadow p-3">
            <h1 class="h4 text-center mb-3"><i class="fas fa-bus"></i> Tempahan Bas Pulang Bermalam</h1>

            <div id="adminToolsHeader" class="d-flex justify-content-end gap-1 mb-3" style="display:none">
                <button id="adminLoginHeaderBtn" class="btn btn-sm p-1" title="Admin" onclick="openAdminLoginModal()" style="width:28px;height:28px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:12px">
                    <i class="fas fa-user-lock"></i>
                </button>
                <button id="footerSettingsHeaderBtn" class="btn btn-sm p-1" title="Tetapan Bas" onclick="openAdminSettingsModal()" style="width:28px;height:28px;border-radius:50%;display:none;align-items:center;justify-content:center;font-size:12px">
                    <i class="fas fa-cog"></i>
                </button>
                <button id="footerEditJourneyHeaderBtn" class="btn btn-sm p-1" title="Edit Perjalanan" onclick="openAdminModalForEdit()" style="width:28px;height:28px;border-radius:50%;display:none;align-items:center;justify-content:center;font-size:12px">
                    <i class="fas fa-pen"></i>
                </button>
                <button id="footerDownloadHeaderBtn" class="btn btn-sm p-1" title="Muat Turun" onclick="downloadSenarai()" disabled style="width:28px;height:28px;border-radius:50%;display:none;align-items:center;justify-content:center;font-size:12px">
                    <i class="fas fa-download"></i>
                </button>
                <button id="footerDownloadNonBookedHeaderBtn" class="btn btn-sm p-1" title="Muat Turun (Tidak Tempah)" onclick="downloadNonBooked()" disabled style="width:28px;height:28px;border-radius:50%;display:none;align-items:center;justify-content:center;font-size:12px">
                    <i class="fas fa-user-clock"></i>
                </button>
                <button id="footerWhatsAppHeaderBtn" class="btn btn-sm p-1" title="Eksport ke WhatsApp" onclick="exportWhatsAppBooked()" disabled style="width:28px;height:28px;border-radius:50%;display:none;align-items:center;justify-content:center;font-size:12px">
                    <i class="fab fa-whatsapp"></i>
                </button>
                <button id="footerBulkDeleteHeaderBtn" class="btn btn-sm p-1" title="Padam Terpilih" onclick="openAdminModalForBulkDelete()" disabled style="width:28px;height:28px;border-radius:50%;display:none;align-items:center;justify-content:center;font-size:12px">
                    <i class="fas fa-trash"></i>
                </button>
                <button id="footerImportHeaderBtn" class="btn btn-sm p-1" title="Import CSV (Admin)" onclick="openAdminImportModal()" style="width:28px;height:28px;border-radius:50%;display:none;align-items:center;justify-content:center;font-size:12px">
                    <i class="fas fa-file-upload"></i>
                </button>
                <button id="footerExportJsonHeaderBtn" class="btn btn-sm p-1" title="Eksport DB (JSON)" onclick="exportBookingsToFile()" style="width:28px;height:28px;border-radius:50%;display:none;align-items:center;justify-content:center;font-size:12px">
                    <i class="fas fa-file-download"></i>
                </button>
                <button id="footerImportJsonHeaderBtn" class="btn btn-sm p-1" title="Import DB (JSON)" onclick="openAdminDBModal()" style="width:28px;height:28px;border-radius:50%;display:none;align-items:center;justify-content:center;font-size:12px">
                    <i class="fas fa-file-import"></i>
                </button>
                <button id="resetAllHeaderBtn" class="btn btn-sm p-1" title="Reset Semua" onclick="resetAllWithConfirm()" style="width:28px;height:28px;border-radius:50%;display:none;align-items:center;justify-content:center;font-size:12px">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button id="adminLogoutHeaderBtn" class="btn btn-sm p-1 d-none" title="Log Keluar" onclick="adminLogout()" style="width:28px;height:28px;border-radius:50%;display:none;align-items:center;justify-content:center;font-size:12px">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>

            <div id="message" class="alert mb-2" role="alert" style="display:none"></div>

            <div class="text-center mb-3">
                <div id="journeyHeader" class="small text-muted p-2" style="background-color:#fff3cd;border-left:4px solid #ffc107;display:inline-block;border-radius:4px;font-weight:bold">
                    Sila tetapkan perjalanan
                </div>
                
            </div>

            <div class="row g-3">
                <div class="col-md-4">
                    <div class="mb-2">
                        <select id="genderFilter" class="form-select form-select-sm" onchange="updateStudentsByFilter()">
                            <option value="">-- Pilih Jantina --</option>
                            <option value="LELAKI">Lelaki</option>
                            <option value="PEREMPUAN">Perempuan</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <select id="classFilter" class="form-select form-select-sm" onchange="updateStudentsByFilter()">
                            <option value="">-- Pilih Tingkatan --</option>
                            <option value="1">T1</option>
                            <option value="2">T2</option>
                            <option value="3">T3</option>
                            <option value="4">T4</option>
                            <option value="5">T5</option>
                        </select>
                    </div>
                    <div id="studentList" class="list-group mb-3">
                        <div class="text-center text-muted py-4"><i class="fas fa-inbox"></i></div>
                    </div>
                    <div class="text-center">
                        <div id="selectedStudentAlert" class="alert alert-info d-none small mb-2"><i class="fas fa-check-circle"></i> <strong id="selectedStudentText"></strong></div>
                        <button id="confirmBtn" class="btn btn-success btn-sm" onclick="confirmBooking()"> <i class="fas fa-check"></i> Sahkan Tempahan</button>
                    </div>
                </div>

                <div class="col-md-4">
                    <h6 class="mb-2 text-center">Senarai Tempahan</h6>
                    <div class="d-flex justify-content-between mb-2">
                        <div></div>
                    </div>
                    <div id="bookedList" class="list-group" style="max-height:420px;overflow:auto">
                        <div class="text-center text-muted py-4"><i class="fas fa-inbox"></i> Tiada tempahan</div>
                    </div>
                </div>
            </div>

            
        </div>
    </div>

    <!-- Admin modals -->
    <div class="modal fade" id="adminModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 id="adminModalTitle" class="modal-title">Pengesahan Admin</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div id="adminModalBody" class="modal-body"><label class="form-label small">Kata Laluan Admin:</label><input id="adminPassword" class="form-control form-control-sm" type="password"></div><div id="adminModalFooter" class="modal-footer"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Batal</button><button class="btn btn-danger btn-sm" onclick="deleteAfterAuth()">Padam</button></div></div></div></div>

    <div class="modal fade" id="adminImportModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Import Data Pelajar</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="importMessage" class="alert mb-3" style="display:none"></div>
            <div id="adminImportPasswordContainer">
                <label class="form-label small">Kata Laluan Admin:</label>
                <input id="adminImportPassword" class="form-control form-control-sm mb-2" type="password">
            </div>
            <div id="adminImportLoggedInNotice" class="alert alert-info mb-2" style="display:none">Admin sudah log masuk — tidak perlu kata laluan.</div>
            <label class="form-label small">Pilih Fail CSV</label>
            <input id="csvImportFile" class="form-control form-control-sm mb-2" type="file" accept=".csv" onchange="previewImportCSV()">
                <div id="importPreviewSection" style="display:none"><div class="table-responsive"><table class="table table-sm table-bordered"><thead id="importPreviewHead"></thead><tbody id="importPreviewBody"></tbody></table></div><small id="importRowCount" class="text-muted"></small></div></div><div class="modal-footer"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Batal</button><button id="confirmImportBtn" class="btn btn-danger btn-sm" onclick="confirmImportStudents()" disabled>Tukar Data Pelajar</button></div></div></div></div>

            <div class="modal fade" id="editJourneyModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Edit Perjalanan</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><label class="form-label small">Arah Perjalanan</label><select id="editJourneyDirection" class="form-select form-select-sm mb-3" onchange="updateJourneyDestinationOptions()"><option value="">-- Pilih Arah --</option><option value="1">Perjalanan dari MTSD ke Sungai Petani/Gurun/Alor Setar</option><option value="2">Perjalanan dari Sungai Petani/Gurun/Alor Setar ke MTSD</option></select><label class="form-label small">Tarikh dan Masa</label><input id="editJourneyDateTime" class="form-control form-control-sm mb-2" type="datetime-local"></div><div class="modal-footer"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Batal</button><button class="btn btn-primary btn-sm" onclick="openAdminModalForEditConfirm()">Simpan</button></div></div></div></div>

            <div class="modal fade" id="adminSettingsModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Tetapan Aplikasi</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><label class="form-label small">Jumlah Bas</label><input id="settingsBusCount" type="number" min="1" max="10" class="form-control form-control-sm mb-2"><div class="form-check form-switch mb-2"><input id="settingsSegregation" class="form-check-input" type="checkbox"><label class="form-check-label">Aktifkan Segregasi Jantina</label></div><small class="text-muted">Ubah jumlah bas akan mengubah kapasiti total (Kapasiti setiap bas: 44).</small></div><div class="modal-footer"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Batal</button><button class="btn btn-primary btn-sm" onclick="saveAdminSettings()">Simpan</button></div></div></div></div>

            <div class="modal fade" id="adminDBModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Import / Eksport DB (JSON)</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><label class="form-label small">Pilih Fail JSON yang mengandungi objek tempahan</label><input id="dbImportFile" class="form-control form-control-sm mb-2" type="file" accept=".json" onchange="previewImportBookings()">
                <div class="mb-2">
                    <label class="form-label small">Mod Import</label>
                    <div>
                        <div class="form-check"><input class="form-check-input" type="radio" name="importMode" id="importModeOverwrite" value="overwrite" checked><label class="form-check-label small" for="importModeOverwrite">Gantikan semua (Overwrite)</label></div>
                        <div class="form-check"><input class="form-check-input" type="radio" name="importMode" id="importModeMerge" value="merge"><label class="form-check-label small" for="importModeMerge">Gabungkan (tambah entri baru; jangan buang yang sedia ada)</label></div>
                    </div>
                </div>
                <div class="form-check mb-2"><input id="dbAutoBackup" class="form-check-input" type="checkbox" checked><label class="form-check-label small">Buat salinan sandaran (auto-download) sebelum import</label></div>
                <div id="dbImportPreview" style="display:none"><h6 class="small">Pratonton</h6><pre id="dbImportPreviewText" class="small p-2" style="background:#f8f9fa;max-height:200px;overflow:auto"></pre><div id="dbImportPreviewCount" class="small text-muted"></div><div id="dbImportPreviewSummary" class="small text-muted mt-1"></div>
                    <div id="dbConflictList" class="mt-2" style="display:block"></div>
                </div></div><div class="modal-footer"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Batal</button><button id="dbUndoImportBtn" class="btn btn-warning btn-sm" onclick="undoLastImport()" disabled>Undo Import</button><button id="dbImportConfirmBtn" class="btn btn-danger btn-sm" onclick="confirmImportBookings()" disabled>Import</button></div></div></div></div>

            

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        
        const BUS_CAPACITY = 44;
        // number of buses (configurable)
        let busCount = 2;
        // Admin password reconstructed from three scrambled chunks.
        // Note: this only obscures the string in the source; it does not secure it.
        function reverseString(s){ return s.split('').reverse().join(''); }
        const _chunk1 = 'wop';   // scrambled for 'pow'
        const _chunk2 = '@re';   // scrambled for 'er@'
        const _chunk3 = '!321';  // scrambled for '123!'
        const SECRET_PASS = reverseString(_chunk1) + reverseString(_chunk2) + reverseString(_chunk3);

        // Helper: produce a compact timestamp string used in filenames
        function getTimestamp(){
            const now = new Date();
            const yyyy = now.getFullYear();
            const MM = String(now.getMonth() + 1).padStart(2,'0');
            const dd = String(now.getDate()).padStart(2,'0');
            const HH = String(now.getHours()).padStart(2,'0');
            const mm = String(now.getMinutes()).padStart(2,'0');
            const ss = String(now.getSeconds()).padStart(2,'0');
            return `${yyyy}${MM}${dd}_${HH}${mm}${ss}`;
        }

        // Helper: assign booked names into bus groups according to settings.
        // Returns an object { bus1final, bus2final }
        function assignBuses(names){
            let bus1final = [];
            let bus2final = [];
            if(busSegregationEnabled){
                const lelaki = names.filter(n => { const student = allStudentsData.find(s => s.nama === n); return student?.jantina === 'LELAKI'; });
                const perempuan = names.filter(n => { const student = allStudentsData.find(s => s.nama === n); return student?.jantina === 'PEREMPUAN'; });

                const bus1 = lelaki.slice(0, BUS_CAPACITY);
                const lelakiremainder = lelaki.slice(BUS_CAPACITY);

                let bus2 = perempuan.slice(0, BUS_CAPACITY - lelakiremainder.length);
                bus2 = bus2.concat(lelakiremainder.slice(0, BUS_CAPACITY - bus2.length));

                const perempuanoverflow = perempuan.slice(BUS_CAPACITY - lelakiremainder.length);
                const bus1overflow = perempuanoverflow.slice(0, BUS_CAPACITY - bus1.length);
                bus1final = bus1.concat(bus1overflow);
                bus2final = bus2;
            } else {
                bus1final = names.slice(0, BUS_CAPACITY);
                bus2final = names.slice(BUS_CAPACITY, BUS_CAPACITY * busCount);
            }
            return { bus1final, bus2final };
        }

        let allStudentsData = [];
        let filteredStudents = [];
        let selectedStudent = null;
        let bookings = {};
        let selectedBulk = new Set();
        let pendingDeleteList = [];
        let pendingJourneyEdit = null;
        let isAdmin = false;
        let pendingSettingsOpen = false;
        let pendingDBImportOpen = false;
        let parsedImportBookings = null;
        // Keep last import backup in-memory for quick undo; also persisted to localStorage key
        let lastImportBackup = null;
        // IndexedDB available flag and db handle
        let idbAvailable = false;
        let idbHandle = null;
        // Conflict review state
        let importConflictKeys = [];
        let importNewKeys = [];
        // Bus segregation setting (persisted)
        let busSegregationEnabled = true;

        function updateAdminUI(){ 
            const adminTools = document.getElementById('adminToolsHeader'); 
            const loginBtn = document.getElementById('adminLoginHeaderBtn'); 
            const logoutBtn = document.getElementById('adminLogoutHeaderBtn'); 
            const downloadBtn = document.getElementById('footerDownloadHeaderBtn');
            const deleteBtn = document.getElementById('footerBulkDeleteHeaderBtn');
            const importBtn = document.getElementById('footerImportHeaderBtn');
            const editBtn = document.getElementById('footerEditJourneyHeaderBtn');
            const settingsBtn = document.getElementById('footerSettingsHeaderBtn');
            const nonBookedBtn = document.getElementById('footerDownloadNonBookedHeaderBtn');
            const whatsappBtn = document.getElementById('footerWhatsAppHeaderBtn');
            const resetBtn = document.getElementById('resetAllHeaderBtn');
            if(isAdmin){ 
                adminTools.style.display = 'flex'; 
                loginBtn.style.display = 'none'; 
                logoutBtn.classList.remove('d-none'); 
                logoutBtn.style.display = 'inline-flex';
                if(downloadBtn) downloadBtn.style.display = 'inline-flex';
                if(nonBookedBtn) nonBookedBtn.style.display = 'inline-flex';
                if(whatsappBtn) whatsappBtn.style.display = 'inline-flex';
                if(deleteBtn) deleteBtn.style.display = 'inline-flex';
                if(importBtn) importBtn.style.display = 'inline-flex';
                if(editBtn) editBtn.style.display = 'inline-flex';
                if(settingsBtn) settingsBtn.style.display = 'inline-flex';
                if(resetBtn) resetBtn.style.display = 'inline-flex';
                const exportJsonBtn = document.getElementById('footerExportJsonHeaderBtn');
                const importJsonBtn = document.getElementById('footerImportJsonHeaderBtn');
                if(exportJsonBtn) exportJsonBtn.style.display = 'inline-flex';
                if(importJsonBtn) importJsonBtn.style.display = 'inline-flex';
            } else { 
                loginBtn.style.display = 'inline-flex'; 
                logoutBtn.classList.add('d-none');
                logoutBtn.style.display = 'none';
                if(downloadBtn) downloadBtn.style.display = 'none';
                if(nonBookedBtn) nonBookedBtn.style.display = 'none';
                if(whatsappBtn) whatsappBtn.style.display = 'none';
                if(deleteBtn) deleteBtn.style.display = 'none';
                if(importBtn) importBtn.style.display = 'none';
                if(editBtn) editBtn.style.display = 'none';
                if(settingsBtn) settingsBtn.style.display = 'none';
                if(resetBtn) resetBtn.style.display = 'none';
                const exportJsonBtn = document.getElementById('footerExportJsonHeaderBtn');
                const importJsonBtn = document.getElementById('footerImportJsonHeaderBtn');
                if(exportJsonBtn) exportJsonBtn.style.display = 'none';
                if(importJsonBtn) importJsonBtn.style.display = 'none';
            } 
        }

        function showMessage(text, type='info'){
            const el = document.getElementById('message'); el.textContent = text; el.className = 'alert alert-' + type; el.style.display='block'; setTimeout(()=>el.style.display='none',3000);
        }

        function formatName(name){
            if(!name) return '';
            let r = name.toLowerCase().trim().split(/\s+/).map(w=>
                w.split('-').map(p=>{
                    if(!p) return p;
                    return p.split("'").map((s,idx)=>{
                        if(!s) return s;
                        if(idx === 0) return s.charAt(0).toUpperCase() + s.slice(1);
                        if(p.charAt(0) === "'") return s.charAt(0).toUpperCase() + s.slice(1);
                        return s;
                    }).join("'");
                }).join('-')
            ).join(' ');
            r = r.replace(/\b(Bin|Binti)\b/gi, m=>m.toLowerCase());
            return r;
        }

        function loadStudentsDataFromStorage(){ const s = localStorage.getItem('studentData'); if(s) { try{ allStudentsData = JSON.parse(s); return true; }catch(e){ console.error(e); } } return false; }
        function saveStudentsDataToStorage(){ localStorage.setItem('studentData', JSON.stringify(allStudentsData)); }
        async function loadStudentsData(){ if(loadStudentsDataFromStorage()) return; try{ const resp = await fetch('students_data.json'); if(!resp.ok) throw new Error('load failed'); allStudentsData = await resp.json(); saveStudentsDataToStorage(); }catch(e){ console.error(e); showMessage('Gagal muat data', 'danger'); } }

        function loadBookings(){ const s = localStorage.getItem('busBookings'); if(s) bookings = JSON.parse(s); }
        // Storage abstraction: try IndexedDB first, otherwise localStorage
        async function initIndexedDB(){
            if(!('indexedDB' in window)) return false;
            return new Promise((resolve)=>{
                const req = indexedDB.open('mtsd_bas_db', 1);
                req.onupgradeneeded = function(e){ const db = e.target.result; if(!db.objectStoreNames.contains('kv')) db.createObjectStore('kv', { keyPath: 'k' }); };
                req.onsuccess = function(e){ idbHandle = e.target.result; idbAvailable = true; resolve(true); };
                req.onerror = function(){ idbAvailable = false; resolve(false); };
            });
        }

        function idbGet(key){ return new Promise((resolve, reject)=>{ if(!idbHandle) return resolve(null); try{ const tx = idbHandle.transaction('kv','readonly'); const store = tx.objectStore('kv'); const r = store.get(key); r.onsuccess = ()=> resolve(r.result ? r.result.v : null); r.onerror = ()=> resolve(null); }catch(e){ resolve(null); } }); }
        function idbSet(key, value){ return new Promise((resolve,reject)=>{ if(!idbHandle) return resolve(false); try{ const tx = idbHandle.transaction('kv','readwrite'); const store = tx.objectStore('kv'); const obj = { k: key, v: value }; const r = store.put(obj); r.onsuccess = ()=> resolve(true); r.onerror = ()=> resolve(false); }catch(e){ resolve(false); } }); }

        async function loadBookings(){
            // Try to initialize IndexedDB if available
            await initIndexedDB();
            if(idbAvailable){
                const data = await idbGet('bookings');
                if(data && typeof data === 'object') { bookings = data; return; }
            }
            // fallback to localStorage
            const s = localStorage.getItem('busBookings'); if(s) bookings = JSON.parse(s);
        }

        function saveBookings(){
            try{ localStorage.setItem('busBookings', JSON.stringify(bookings)); }catch(e){}
            if(idbAvailable){ idbSet('bookings', bookings).catch(()=>{}); }
        }
        function loadJourneyHeader(){ const s = localStorage.getItem('journeyHeader'); if(!s) return; const d=JSON.parse(s); const h=document.getElementById('journeyHeader'); if(h) h.innerHTML = `${d.text}<br><small class="text-muted">${d.date}</small>`; }
        function saveJourneyHeader(text,date){ localStorage.setItem('journeyHeader', JSON.stringify({text,date})); const h=document.getElementById('journeyHeader'); if(h) h.innerHTML = `${text}<br><small class="text-muted">${date}</small>`; }

        // Export bookings to JSON file (download)
        function exportBookingsToFile(){
            const timestamp = getTimestamp();
            const payload = { meta: { exportedAt: new Date().toISOString() }, bookings };
            const a = document.createElement('a');
            a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(payload, null, 2));
            a.download = `bookings_${timestamp}.json`;
            document.body.appendChild(a); a.click(); a.remove();
            showMessage('DB dieksport','success');
        }

        function createBackupBeforeImport(){
            try{
                const payload = { meta: { backupAt: new Date().toISOString() }, bookings };
                lastImportBackup = payload;
                // persist as string so undo works across reloads
                localStorage.setItem('bookings_backup_before_import', JSON.stringify(payload));
                // also trigger download for manual backup
                const ts = getTimestamp();
                const a = document.createElement('a');
                a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(payload, null, 2));
                a.download = `bookings_backup_${ts}.json`;
                document.body.appendChild(a); a.click(); a.remove();
                return true;
            }catch(e){ console.error('backup failed', e); return false; }
        }

        function openAdminDBModal(){
            if(!isAdmin){ pendingDBImportOpen = true; openAdminLoginModal(); return; }
            document.getElementById('dbImportFile').value = '';
            document.getElementById('dbImportPreview').style.display = 'none';
            document.getElementById('dbImportPreviewText').textContent = '';
            document.getElementById('dbImportPreviewCount').textContent = '';
            document.getElementById('dbImportConfirmBtn').disabled = true;
            document.getElementById('dbUndoImportBtn').disabled = !localStorage.getItem('bookings_backup_before_import');
            document.getElementById('dbImportPreviewSummary').textContent = '';
            // clear conflict lists
            importConflictKeys = [];
            importNewKeys = [];
            const conflictContainer = document.getElementById('dbConflictList'); if(conflictContainer) conflictContainer.innerHTML='';
            new bootstrap.Modal(document.getElementById('adminDBModal')).show();
        }

        function previewImportBookings(){
            const f = document.getElementById('dbImportFile').files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = e => {
                try{
                    const parsed = JSON.parse(e.target.result);
                    // Accept either { bookings: {...} } or plain bookings object
                    const data = parsed.bookings || parsed;
                    if(typeof data !== 'object' || Array.isArray(data)) throw new Error('Invalid format');
                    parsedImportBookings = data;
                    const keys = Object.keys(data);
                    document.getElementById('dbImportPreviewText').textContent = JSON.stringify(Object.fromEntries(keys.slice(0,200).map(k=>[k, data[k]])), null, 2);
                    document.getElementById('dbImportPreviewCount').textContent = `Objek tempahan: ${keys.length}`;
                    // compute summary: new vs conflicts
                    const existingKeys = new Set(Object.keys(bookings));
                    let conflicts = 0; let additions = 0;
                    importConflictKeys = [];
                    importNewKeys = [];
                    keys.forEach(k=>{ if(existingKeys.has(k)){ conflicts++; importConflictKeys.push(k); } else { additions++; importNewKeys.push(k); } });
                    document.getElementById('dbImportPreviewSummary').textContent = `Baru: ${additions}  Konflik (sudah ada): ${conflicts}`;
                    // build small conflict UI
                    const conflictContainer = document.getElementById('dbConflictList'); conflictContainer.innerHTML = '';
                    if(importNewKeys.length){
                        const s = document.createElement('div'); s.className='small mb-1'; s.textContent = `Baru (pilih untuk import): ${importNewKeys.length}`; conflictContainer.appendChild(s);
                        const ul = document.createElement('div'); importNewKeys.slice(0,200).forEach(k=>{ const row=document.createElement('div'); row.className='form-check'; row.innerHTML = `<input class="form-check-input" type="checkbox" id="inc_${CSS.escape(k)}" checked><label class="form-check-label small" for="inc_${CSS.escape(k)}">${k}</label>`; ul.appendChild(row); }); conflictContainer.appendChild(ul);
                    }
                    if(importConflictKeys.length){
                        const s2 = document.createElement('div'); s2.className='small mt-2 mb-1'; s2.textContent = `Konflik (pilih tindakan untuk setiap nama): ${importConflictKeys.length}`; conflictContainer.appendChild(s2);
                        const list = document.createElement('div'); importConflictKeys.slice(0,200).forEach(k=>{
                            const existingVal = bookings[k];
                            const incomingVal = data[k];
                            const row = document.createElement('div'); row.className='mb-2 p-2'; row.style.background='#fff';
                            row.innerHTML = `<div class="small fw-bold">${k}</div><div class="small text-muted">Sedia ada: ${JSON.stringify(existingVal)} &nbsp;|&nbsp; Import: ${JSON.stringify(incomingVal)}</div>`;
                            const opt1 = document.createElement('div'); opt1.className='form-check form-check-inline'; opt1.innerHTML = `<input class="form-check-input" type="radio" name="conf_${CSS.escape(k)}" id="conf_keep_${CSS.escape(k)}" value="keep" checked><label class="form-check-label small" for="conf_keep_${CSS.escape(k)}">Kekalkan sedia ada</label>`;
                            const opt2 = document.createElement('div'); opt2.className='form-check form-check-inline'; opt2.innerHTML = `<input class="form-check-input" type="radio" name="conf_${CSS.escape(k)}" id="conf_replace_${CSS.escape(k)}" value="replace"><label class="form-check-label small" for="conf_replace_${CSS.escape(k)}">Gantikan dengan import</label>`;
                            row.appendChild(opt1); row.appendChild(opt2); list.appendChild(row);
                        }); conflictContainer.appendChild(list);
                    }
                    document.getElementById('dbImportPreview').style.display = 'block';
                    document.getElementById('dbImportConfirmBtn').disabled = false;
                }catch(err){
                    parsedImportBookings = null;
                    document.getElementById('dbImportPreviewText').textContent = 'Gagal baca JSON: ' + err.message;
                    document.getElementById('dbImportPreviewCount').textContent = '';
                    document.getElementById('dbImportPreview').style.display = 'block';
                    document.getElementById('dbImportConfirmBtn').disabled = true;
                }
            };
            r.readAsText(f,'utf-8');
        }

        function confirmImportBookings(){
            if(!isAdmin){ showMessage('Perlu log masuk sebagai admin','danger'); return; }
            if(!parsedImportBookings){ showMessage('Tiada data untuk diimport','danger'); return; }
            // Auto-backup if requested
            const autoBackup = document.getElementById('dbAutoBackup')?.checked;
            if(autoBackup){ createBackupBeforeImport(); }

            // Read selected mode
            const mode = document.querySelector('input[name="importMode"]:checked')?.value || 'overwrite';
            if(mode === 'overwrite'){
                // If per-key UI present, respect choices
                const final = {};
                // include only new keys checked
                importNewKeys.forEach(k=>{ const chk = document.getElementById('inc_' + k); if(!chk || chk.checked) final[k] = parsedImportBookings[k]; });
                // for conflicts, apply per-key choice
                importConflictKeys.forEach(k=>{ const sel = document.querySelector('input[name="conf_' + k + '"]:checked'); if(sel && sel.value === 'replace'){ final[k] = parsedImportBookings[k]; } else { /* keep existing, so copy from bookings if present */ if(bookings[k]) final[k] = bookings[k]; } });
                // also include any other keys in parsedImportBookings not listed (defensive)
                Object.keys(parsedImportBookings).forEach(k=>{ if(!final.hasOwnProperty(k) && parsedImportBookings[k] !== undefined) final[k] = parsedImportBookings[k]; });
                bookings = final;
            } else if(mode === 'merge'){
                // merge: add keys that don't exist yet, but allow exclusions via checkboxes
                const newBookings = Object.assign({}, bookings);
                importNewKeys.forEach(k=>{ const chk = document.getElementById('inc_' + k); if(!chk || chk.checked) newBookings[k] = parsedImportBookings[k]; });
                // conflicts: keep existing (default) or replace if chosen
                importConflictKeys.forEach(k=>{ const sel = document.querySelector('input[name="conf_' + k + '"]:checked'); if(sel && sel.value === 'replace'){ newBookings[k] = parsedImportBookings[k]; } });
                bookings = newBookings;
            }
            saveBookings();
            selectedBulk.clear();
            updateStudentsByFilter();
            updateBookedList();
            // enable undo if backup exists
            const undoBtn = document.getElementById('dbUndoImportBtn');
            if(undoBtn){
                const hasBackup = !!localStorage.getItem('bookings_backup_before_import');
                undoBtn.disabled = !hasBackup;
            }
            bootstrap.Modal.getInstance(document.getElementById('adminDBModal')).hide();
            showMessage('DB diimport','success');
        }

        function undoLastImport(){
            const raw = localStorage.getItem('bookings_backup_before_import');
            if(!raw){ showMessage('Tiada sandaran import ditemui','warning'); return; }
            try{
                const parsed = JSON.parse(raw);
                const data = parsed.bookings || parsed;
                if(typeof data !== 'object') throw new Error('format sandaran tidak sah');
                bookings = data;
                saveBookings();
                selectedBulk.clear();
                updateStudentsByFilter();
                updateBookedList();
                // clear backup after undo to avoid repeated undos
                localStorage.removeItem('bookings_backup_before_import');
                lastImportBackup = null;
                document.getElementById('dbUndoImportBtn').disabled = true;
                showMessage('Import dibatalkan (undo) — sandaran dipulihkan','success');
            }catch(e){ showMessage('Gagal pulihkan sandaran: '+e.message,'danger'); }
        }

        

        function openAdminLoginModal(){ document.getElementById('adminPassword').value=''; document.getElementById('adminModalTitle').textContent='Log Masuk Admin'; document.getElementById('adminModalBody').innerHTML = '<label class="form-label small">Kata Laluan Admin:</label><input id="adminPassword" class="form-control form-control-sm" type="password">'; document.getElementById('adminModalFooter').innerHTML = '<button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Batal</button><button class="btn btn-primary btn-sm" onclick="doAdminLogin()">Log Masuk</button>'; new bootstrap.Modal(document.getElementById('adminModal')).show(); }
        function doAdminLogin(){ const p = document.getElementById('adminPassword').value; if(p!==SECRET_PASS){ showMessage('Kata laluan salah','danger'); return; } isAdmin=true; updateAdminUI(); const adminModalEl = document.getElementById('adminModal'); const adminModalInst = bootstrap.Modal.getInstance(adminModalEl) || bootstrap.Modal.getOrCreateInstance(adminModalEl); if(adminModalInst) adminModalInst.hide(); showMessage('Berjaya log masuk','success'); if(pendingSettingsOpen){ pendingSettingsOpen = false; openAdminSettingsModal(); } if(pendingDBImportOpen){ pendingDBImportOpen = false; openAdminDBModal(); } }
        function adminLogout(){ isAdmin=false; updateAdminUI(); showMessage('Admin log keluar','info'); }

        function resetAllWithConfirm(){
            if(!confirm('Reset semua tempahan dan perjalanan?')) return;
            bookings = {};
            saveBookings();
            selectedBulk.clear();
            localStorage.removeItem('journeyHeader');
            const h = document.getElementById('journeyHeader');
            if(h) h.innerHTML = `Sila tetapkan perjalanan`;
            updateBookedList();
            updateStudentList();
            showMessage('Semua data di-reset','success');
        }

        function updateStudentsByFilter(){ const g=document.getElementById('genderFilter').value; const t=document.getElementById('classFilter').value; if(!g||!t){ filteredStudents=[]; updateStudentList(); return; } filteredStudents = allStudentsData.filter(s=>s.jantina===g && s.tingkatan===t); filteredStudents.sort((a,b)=>a.nama.localeCompare(b.nama)); updateStudentList(); }

        function updateStudentList(){ const list=document.getElementById('studentList'); const g=document.getElementById('genderFilter').value; const t=document.getElementById('classFilter').value; if(!g||!t){ list.innerHTML='<div class="text-center text-muted py-4"><i class="fas fa-inbox"></i> Pilih jantina dan tingkatan</div>'; return; } if(filteredStudents.length===0){ list.innerHTML='<div class="text-center text-muted py-4"><i class="fas fa-inbox"></i> Tiada pelajar</div>'; return; } list.innerHTML=''; filteredStudents.forEach(s=>{ const item=document.createElement('div'); item.className='list-group-item d-flex align-items-center'; const r=document.createElement('input'); r.type='radio'; r.className='form-check-input me-2'; r.name='studentSelection'; r.value=s.nama; r.checked = s.nama===selectedStudent; const booked = !!bookings[s.nama]; r.disabled = booked; r.onchange = ()=>selectStudent(s.nama); const lbl=document.createElement('label'); lbl.className='mb-0 small form-check-label flex-grow-1'; lbl.textContent = formatName(s.nama); lbl.onclick = ()=>{ if(!r.disabled){ r.checked=true; selectStudent(s.nama);} }; item.appendChild(r); item.appendChild(lbl); if(booked){ const b=document.createElement('span'); b.className='badge bg-warning text-dark ms-2 small'; b.textContent='Sudah menempah'; item.appendChild(b);} list.appendChild(item); }); }

        function selectStudent(name){ selectedStudent=name; const alert=document.getElementById('selectedStudentAlert'); const text=document.getElementById('selectedStudentText'); text.textContent=formatName(name); const btn=document.getElementById('confirmBtn'); if(bookings[name]){ alert.className='alert alert-warning small'; btn.disabled=true; } else { alert.className='alert alert-info small'; btn.disabled=false; } alert.classList.remove('d-none'); updateStudentList(); }

        function confirmBooking(){ if(!selectedStudent){ showMessage('Sila pilih pelajar','danger'); return; } if(bookings[selectedStudent]){ showMessage('Sudah menempah','warning'); return; } if(Object.keys(bookings).length>= (BUS_CAPACITY * busCount) ){ showMessage('Kapasiti penuh','danger'); return; } bookings[selectedStudent]=true; saveBookings(); showMessage('Tempahan disahkan','success'); selectedStudent=null; updateStudentList(); updateBookedList(); }

        function updateBookedList(){ 
            const el=document.getElementById('bookedList'); 
            const names=Object.keys(bookings);
            
            const { bus1final, bus2final } = assignBuses(names);
            
            if(names.length===0){ 
                el.innerHTML='<div class="text-center text-muted py-4"><i class="fas fa-inbox"></i> Tiada tempahan</div>'; 
                document.getElementById('bulkDeleteBtn').disabled=true; 
                const footDownload = document.getElementById('footerDownloadBtn'); 
                if(footDownload) footDownload.disabled = true; 
                const headerDownload = document.getElementById('footerDownloadHeaderBtn'); 
                if(headerDownload) headerDownload.disabled = true; 
                const headerNonBookedEarly = document.getElementById('footerDownloadNonBookedHeaderBtn');
                if(headerNonBookedEarly) headerNonBookedEarly.disabled = true;
                updateSelectAllCheckbox(); 
                return; 
            } 
            el.innerHTML=''; 
            
            if(bus1final.length){ 
                const h=document.createElement('div'); 
                h.className='list-group-item bg-light'; 
                h.textContent=`Bas 1 (${bus1final.length}/${BUS_CAPACITY})`; 
                el.appendChild(h); 
                bus1final.forEach((n,i)=>{ 
                    const it=document.createElement('div'); 
                    it.className = 'list-group-item d-flex align-items-center justify-content-between';
                    const left = document.createElement('div'); left.className='d-flex align-items-center';
                    const cb = document.createElement('input'); cb.type='checkbox'; cb.className='form-check-input me-2'; cb.checked = selectedBulk.has(n); cb.onchange = ()=>toggleBulkSelect(n, cb.checked);
                    left.appendChild(cb);
                    const nameSpan = document.createElement('span'); nameSpan.className='small'; nameSpan.textContent = `${i+1}. ${formatName(n)}`;
                    left.appendChild(nameSpan);
                    it.appendChild(left);
                    const meta = document.createElement('small'); const student = allStudentsData.find(s=>s.nama===n); const tingkat = student?.tingkatan || '?'; meta.textContent = `F${tingkat}`;
                    it.appendChild(meta);
                    el.appendChild(it);
                }); 
            }
            if(bus2final.length){ 
                const h2=document.createElement('div'); h2.className='list-group-item bg-light'; h2.textContent=`Bas 2 (${bus2final.length}/${BUS_CAPACITY})`; el.appendChild(h2);
                bus2final.forEach((n,i)=>{ 
                    const it=document.createElement('div'); 
                    it.className = 'list-group-item d-flex align-items-center justify-content-between';
                    const left = document.createElement('div'); left.className='d-flex align-items-center';
                    const cb = document.createElement('input'); cb.type='checkbox'; cb.className='form-check-input me-2'; cb.checked = selectedBulk.has(n); cb.onchange = ()=>toggleBulkSelect(n, cb.checked);
                    left.appendChild(cb);
                    const nameSpan = document.createElement('span'); nameSpan.className='small'; nameSpan.textContent = `${i+1}. ${formatName(n)}`;
                    left.appendChild(nameSpan);
                    it.appendChild(left);
                    const meta = document.createElement('small'); const student = allStudentsData.find(s=>s.nama===n); const tingkat = student?.tingkatan || '?'; meta.textContent = `F${tingkat}`;
                    it.appendChild(meta);
                    el.appendChild(it);
                }); 
            }
            // header/footer control enabling
            const topBulk = document.getElementById('bulkDeleteBtn');
            const footBulk = document.getElementById('footerBulkDeleteBtn');
            const headerBulk = document.getElementById('footerBulkDeleteHeaderBtn');
            const footDownload = document.getElementById('footerDownloadBtn');
            const headerDownload = document.getElementById('footerDownloadHeaderBtn');
            if(topBulk) topBulk.disabled = selectedBulk.size===0;
            if(footBulk) footBulk.disabled = selectedBulk.size===0;
            if(headerBulk) headerBulk.disabled = selectedBulk.size===0;
            if(footDownload) footDownload.disabled = names.length===0;
            if(headerDownload) headerDownload.disabled = names.length===0;
            const headerWhatsApp = document.getElementById('footerWhatsAppHeaderBtn');
            if(headerWhatsApp) headerWhatsApp.disabled = names.length===0;
            // enable/disable header non-booked download button
            const headerNonBooked = document.getElementById('footerDownloadNonBookedHeaderBtn');
            const unbookedCount = allStudentsData.filter(s=>!bookings[s.nama]).length;
            if(headerNonBooked) headerNonBooked.disabled = unbookedCount===0;
            updateSelectAllCheckbox(); 
        }

        function toggleBulkSelect(name,checked){ if(checked) selectedBulk.add(name); else selectedBulk.delete(name); const topBulk = document.getElementById('bulkDeleteBtn'); const footBulk = document.getElementById('footerBulkDeleteBtn'); const headerBulk = document.getElementById('footerBulkDeleteHeaderBtn'); if(topBulk) topBulk.disabled = selectedBulk.size===0; if(footBulk) footBulk.disabled = selectedBulk.size===0; if(headerBulk) headerBulk.disabled = selectedBulk.size===0; updateSelectAllCheckbox(); }
        function toggleSelectAll(checked){ const names=Object.keys(bookings); if(checked) names.forEach(n=>selectedBulk.add(n)); else selectedBulk.clear(); updateBookedList(); const footBulk = document.getElementById('footerBulkDeleteBtn'); const headerBulk = document.getElementById('footerBulkDeleteHeaderBtn'); if(footBulk) footBulk.disabled = selectedBulk.size===0; if(headerBulk) headerBulk.disabled = selectedBulk.size===0; }
        function updateSelectAllCheckbox(){ const cb=document.getElementById('selectAllCheckbox'); if(!cb) return; const names=Object.keys(bookings); cb.checked = names.length>0 && selectedBulk.size===names.length; }

        function downloadSenarai(){ 
            const names=Object.keys(bookings); 
            if(names.length===0){ showMessage('Tiada tempahan','warning'); return; } 
            const header=document.getElementById('journeyHeader').innerText.trim(); 
            const timestamp = getTimestamp();
            
            const { bus1final, bus2final } = assignBuses(names);
            
            let content='Tempahan Bas Pulang Bermalam\n';
            content+=`\n${header}\n`;
            content+=`\nJumlah Pelajar: ${names.length}\n`;
            
            if(bus1final.length){ 
                content+=`\n--- BAS 1 (${bus1final.length}/${BUS_CAPACITY}) ---\n`;
                bus1final.forEach((n,i)=>{ 
                    const student = allStudentsData.find(s=>s.nama===n);
                    const tingkat = student?.tingkatan || '?';
                    const fFormat = `F${tingkat}`;
                    content+=`${i+1}. ${formatName(n)} (${fFormat})\n`;
                }); 
            }
            if(bus2final.length){ 
                content+=`\n--- BAS 2 (${bus2final.length}/${BUS_CAPACITY}) ---\n`;
                bus2final.forEach((n,i)=>{ 
                    const student = allStudentsData.find(s=>s.nama===n);
                    const tingkat = student?.tingkatan || '?';
                    const fFormat = `F${tingkat}`;
                    content+=`${i+1}. ${formatName(n)} (${fFormat})\n`;
                }); 
            }
            
            content+=`\n---\n${timestamp}`;
            
            const a=document.createElement('a'); 
            a.href='data:text/plain;charset=utf-8,'+encodeURIComponent(content); 
            a.download=`Senarai_Tempahan_Bas_${timestamp}.txt`;
            document.body.appendChild(a); 
            a.click(); 
            a.remove(); 
            showMessage('Dimuat turun','success'); 
        }

        function downloadNonBooked(){
            // names that did NOT book
            const unbooked = allStudentsData.filter(s => !bookings[s.nama]);
            if(unbooked.length===0){ showMessage('Tiada pelajar yang belum menempah','warning'); return; }
            const header = document.getElementById('journeyHeader').innerText.trim();
            const timestamp = getTimestamp();
            let content = 'Senarai Pelajar Tidak Menempah\n';
            content += `\n${header}\n`;
            content += `\nJumlah Tidak Menempah: ${unbooked.length}\n`;
            unbooked.forEach((s,i)=>{
                const tingkat = s.tingkatan || '?';
                const fFormat = 'F' + tingkat;
                content += `${i+1}. ${formatName(s.nama)} (${fFormat})\n`;
            });
            content += `\n---\n${timestamp}`;
            const a=document.createElement('a');
            a.href='data:text/plain;charset=utf-8,'+encodeURIComponent(content);
            a.download = `Senarai_Tidak_Tempah_${timestamp}.txt`;
            document.body.appendChild(a); a.click(); a.remove(); showMessage('Dimuat turun','success');
        }

        function exportWhatsAppBooked(){
            const names = Object.keys(bookings);
            if(names.length===0){ showMessage('Tiada tempahan','warning'); return; }
            const header = document.getElementById('journeyHeader').innerText.trim();

            const { bus1final, bus2final } = assignBuses(names);

            let content = 'Tempahan Bas Pulang Bermalam\n';
            content += `\n${header}\n`;
            content += `\nJumlah Pelajar: ${names.length}\n`;

            if(bus1final.length){
                content += `\n--- BAS 1 (${bus1final.length}/${BUS_CAPACITY}) ---\n`;
                bus1final.forEach((n,i)=>{
                    const student = allStudentsData.find(s=>s.nama===n);
                    const tingkat = student?.tingkatan || '?';
                    const fFormat = 'F' + tingkat;
                    content += `${i+1}. ${formatName(n)} (${fFormat})\n`;
                });
            }
            if(bus2final.length){
                content += `\n--- BAS 2 (${bus2final.length}/${BUS_CAPACITY}) ---\n`;
                bus2final.forEach((n,i)=>{
                    const student = allStudentsData.find(s=>s.nama===n);
                    const tingkat = student?.tingkatan || '?';
                    const fFormat = 'F' + tingkat;
                    content += `${i+1}. ${formatName(n)} (${fFormat})\n`;
                });
            }

            content += `\n---\n`;

            // Try copying to clipboard, then open WhatsApp Web with encoded message as fallback/extra convenience
            const waUrl = 'https://wa.me/?text=' + encodeURIComponent(content);
            if(navigator.clipboard && navigator.clipboard.writeText){
                navigator.clipboard.writeText(content).then(()=>{
                    showMessage('Disalin ke papan klip — membuka WhatsApp...','success');
                    window.open(waUrl, '_blank');
                }).catch(()=>{
                    // if clipboard fails, still open WhatsApp web
                    window.open(waUrl, '_blank');
                    showMessage('Buka WhatsApp...','info');
                });
            } else {
                window.open(waUrl, '_blank');
                showMessage('Buka WhatsApp...','info');
            }
        }

        function openAdminModalForBulkDelete(){
            if (selectedBulk.size === 0) return;
            pendingDeleteList = Array.from(selectedBulk);
            // If admin already logged in, skip password modal and perform deletion after confirmation
            if (isAdmin) {
                const cnt = pendingDeleteList.length;
                if (!confirm(`Padam ${cnt} tempahan terpilih?`)) return;
                deleteAfterAuth();
                return;
            }
            // Show modal with select all option for non-admin
            const modalBody = document.getElementById('adminModalBody');
            document.getElementById('adminPassword').value = '';
            modalBody.innerHTML = '<label class="form-label small">Pilih semua:</label><div class="form-check"><input id="adminDeleteSelectAll" type="checkbox" class="form-check-input" onchange="toggleSelectAllInDeleteModal(this.checked)"><label class="form-check-label small ms-1">Pilih Semua</label></div><br><label class="form-label small">Kata Laluan Admin:</label><input id="adminPassword" class="form-control form-control-sm" type="password">';
            document.getElementById('adminModalTitle').textContent = 'Padam Tempahan';
            document.getElementById('adminModalFooter').innerHTML = '<button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Batal</button><button class="btn btn-danger btn-sm" onclick="deleteAfterAuth()">Padam</button>';
            new bootstrap.Modal(document.getElementById('adminModal')).show();
        }

        function toggleSelectAllInDeleteModal(checked){
            if(checked){ selectedBulk.clear(); Object.keys(bookings).forEach(n=>selectedBulk.add(n)); } else { selectedBulk.clear(); }
        }
        function deleteAfterAuth(){ if(!isAdmin){ const p=document.getElementById('adminPassword').value; if(p!==SECRET_PASS){ showMessage('Kata laluan salah','danger'); return; } } if(pendingDeleteList.length>0){ let c=0; pendingDeleteList.forEach(n=>{ if(bookings[n]){ delete bookings[n]; c++; } }); saveBookings(); selectedBulk.clear(); pendingDeleteList=[]; updateBookedList(); showMessage(`${c} tempahan dipadam`,'success'); bootstrap.Modal.getInstance(document.getElementById('adminModal')).hide(); return; } showMessage('Tiada yang dipadam','info'); }

        function openAdminModalForEdit(){
            // populate modal inputs from saved journeyHeader if present
            const stored = localStorage.getItem('journeyHeader');
            let direction = '';
            let dateTimeValue = '';
            if(stored){ try{ const d = JSON.parse(stored); const text = d.text||''; const date = d.date||''; if(text.includes('ke MTSD')){ direction='2'; } else { direction='1'; } dateTimeValue = date; }catch(e){} }
            document.getElementById('editJourneyDirection').value = direction;
            document.getElementById('editJourneyDateTime').value = dateTimeValue;
            updateJourneyDestinationOptions();
            new bootstrap.Modal(document.getElementById('editJourneyModal')).show();
        }

        function updateJourneyDestinationOptions(){ }

        function formatDateTimeDisplay(isoDateTime){
            if(!isoDateTime) return '';
            const dt = new Date(isoDateTime);
            const days = ['Minggu','Isnin','Selasa','Rabu','Khamis','Jumaat','Sabtu'];
            const months = ['Jan','Feb','Mac','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Dis'];
            const day = days[dt.getDay()];
            const date = dt.getDate();
            const month = months[dt.getMonth()];
            const year = dt.getFullYear();
            let hours = dt.getHours();
            const mins = String(dt.getMinutes()).padStart(2,'0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;
            const hoursStr = String(hours).padStart(2,'0');
            return `${day}, ${date} ${month} ${year} ${hoursStr}:${mins} ${ampm}`;
        }

        function openAdminModalForEditConfirm(){
            const direction = document.getElementById('editJourneyDirection').value;
            const dateTime = document.getElementById('editJourneyDateTime').value;
            if(!direction){ showMessage('Sila pilih arah perjalanan','danger'); return; }
            if(!dateTime){ showMessage('Sila pilih tarikh dan masa','danger'); return; }
            let text = direction === '1' ? 'Perjalanan dari MTSD ke Sungai Petani/Gurun/Alor Setar' : 'Perjalanan dari Sungai Petani/Gurun/Alor Setar ke MTSD';
            const dateDisplay = formatDateTimeDisplay(dateTime);
            // If admin logged in, save directly
            if(isAdmin){ saveJourneyHeader(text,dateDisplay); bootstrap.Modal.getInstance(document.getElementById('editJourneyModal')).hide(); showMessage('Perjalanan dikemaskini','success'); return; }
            // require admin auth: store pending and show admin modal
            pendingJourneyEdit = { text, date: dateDisplay };
            // hide edit modal while asking for admin password
            const editModalEl = document.getElementById('editJourneyModal');
            const editModalInst = bootstrap.Modal.getInstance(editModalEl);
            if(editModalInst) editModalInst.hide();
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminModalTitle').textContent = 'Pengesahan untuk Kemaskini';
            document.getElementById('adminModalBody').innerHTML = '<label class="form-label small">Kata Laluan Admin:</label><input id="adminPassword" class="form-control form-control-sm" type="password">';
            document.getElementById('adminModalFooter').innerHTML = '<button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Batal</button><button class="btn btn-primary btn-sm" onclick="saveJourneyEditAfterAuth()">Sahkan & Simpan</button>';
            new bootstrap.Modal(document.getElementById('adminModal')).show();
        }

        function saveJourneyEditAfterAuth(){
            if(!isAdmin){ const p = document.getElementById('adminPassword').value; if(p!==SECRET_PASS){ showMessage('Kata laluan salah','danger'); return; } isAdmin = true; updateAdminUI(); }
            if(pendingJourneyEdit){ saveJourneyHeader(pendingJourneyEdit.text,pendingJourneyEdit.date); pendingJourneyEdit = null; saveBookings(); bootstrap.Modal.getInstance(document.getElementById('adminModal')).hide(); bootstrap.Modal.getInstance(document.getElementById('editJourneyModal')).hide(); showMessage('Perjalanan dikemaskini','success'); }
        }

        function openAdminImportModal(){
            document.getElementById('adminImportPassword').value = '';
            document.getElementById('csvImportFile').value = '';
            document.getElementById('importPreviewSection').style.display = 'none';
            document.getElementById('confirmImportBtn').disabled = true;
            const pwContainer = document.getElementById('adminImportPasswordContainer');
            const loggedNote = document.getElementById('adminImportLoggedInNotice');
            if(isAdmin){
                if(pwContainer) pwContainer.style.display = 'none';
                if(loggedNote) loggedNote.style.display = 'block';
            } else {
                if(pwContainer) pwContainer.style.display = 'block';
                if(loggedNote) loggedNote.style.display = 'none';
            }
            new bootstrap.Modal(document.getElementById('adminImportModal')).show();
        }
        function previewImportCSV(){ const f=document.getElementById('csvImportFile').files[0]; if(!f) return; const r=new FileReader(); r.onload=e=>{ const csv=e.target.result; const lines=csv.split(/\r?\n/).filter(Boolean); if(lines.length<2){ document.getElementById('importMessage').textContent='CSV tidak sah'; document.getElementById('importMessage').className='alert alert-danger'; document.getElementById('importMessage').style.display='block'; return; } const headers=lines[0].split(',').map(h=>h.trim().toUpperCase()); const rows=[]; for(let i=1;i<lines.length;i++){ const vals=lines[i].split(','); const obj={}; headers.forEach((h,idx)=> obj[h]= (vals[idx]||'').trim()); rows.push(obj); } // preview
            const head=document.getElementById('importPreviewHead'); const body=document.getElementById('importPreviewBody'); head.innerHTML=''; body.innerHTML=''; const tr=document.createElement('tr'); headers.forEach(h=>{ const th=document.createElement('th'); th.textContent=h; tr.appendChild(th); }); head.appendChild(tr); rows.slice(0,5).forEach(rw=>{ const tr2=document.createElement('tr'); headers.forEach(h=>{ const td=document.createElement('td'); td.textContent = rw[h]||''; tr2.appendChild(td); }); body.appendChild(tr2); }); document.getElementById('importRowCount').textContent=`Jumlah baris: ${rows.length}`; document.getElementById('importPreviewSection').style.display='block'; document.getElementById('confirmImportBtn').disabled=false; document.getElementById('importMessage').style.display='none'; }; r.readAsText(f,'utf-8'); }

        function confirmImportStudents(){ if(!isAdmin){ const p=document.getElementById('adminImportPassword').value; if(p!==SECRET_PASS){ document.getElementById('importMessage').textContent='Kata laluan salah'; document.getElementById('importMessage').className='alert alert-danger'; document.getElementById('importMessage').style.display='block'; return; } } const f=document.getElementById('csvImportFile').files[0]; if(!f) return; const r=new FileReader(); r.onload=e=>{ const csv=e.target.result; const lines=csv.split(/\r?\n/).filter(Boolean); const headers=lines[0].split(',').map(h=>h.trim().toUpperCase()); const rows=[]; for(let i=1;i<lines.length;i++){ const vals=lines[i].split(','); const obj={}; headers.forEach((h,idx)=> obj[h]= (vals[idx]||'').trim()); rows.push(obj); } allStudentsData = rows.map(row=>({ nama: row['NAMA']||'', jantina: row['JANTINA']||'', tingkatan: row['TINGKATAN']||'' })); saveStudentsDataToStorage(); bookings={}; saveBookings(); selectedBulk.clear(); updateStudentsByFilter(); updateBookedList(); bootstrap.Modal.getInstance(document.getElementById('adminImportModal')).hide(); showMessage(`Diimport ${allStudentsData.length} pelajar`,'success'); }; r.readAsText(f,'utf-8'); }

        document.addEventListener('DOMContentLoaded', async ()=>{ await loadBookings(); loadJourneyHeader(); await loadStudentsData(); loadSettings(); updateAdminUI(); updateStudentList(); updateBookedList(); });
    </script>
</body>
</html>