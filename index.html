<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tempahan Bas Pulang Bermalam</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>body{min-height:100vh} .small-btn{padding:.28rem .5rem;font-size:.8rem}</style>
</head>
<body class="bg-light">
    <div class="container py-3">
        <div class="bg-white rounded shadow p-3">
            <h1 class="h4 text-center mb-3"><i class="fas fa-bus"></i> Tempahan Bas Pulang Bermalam</h1>

            <div id="message" class="alert mb-2" role="alert" style="display:none"></div>

            <div class="text-center mb-3">
                <div id="journeyHeader" class="small text-muted p-2" style="cursor:pointer;background-color:#fff3cd;border-left:4px solid #ffc107;display:inline-block;border-radius:4px">
                    <i class="fas fa-map-marker-alt"></i> Perjalanan dari MTSD ke Alor Setar<br><small class="text-muted">ðŸ“… Khamis, 20 Nov 2025</small>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-4">
                    <div class="mb-2">
                        <label class="form-label small">Jantina</label>
                        <select id="genderFilter" class="form-select form-select-sm" onchange="updateStudentsByFilter()">
                            <option value="">-- Pilih Jantina --</option>
                            <option value="LELAKI">Lelaki</option>
                            <option value="PEREMPUAN">Perempuan</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Tingkatan</label>
                        <select id="classFilter" class="form-select form-select-sm" onchange="updateStudentsByFilter()">
                            <option value="">-- Pilih Tingkatan --</option>
                            <option value="1">T1</option>
                            <option value="2">T2</option>
                            <option value="3">T3</option>
                            <option value="4">T4</option>
                            <option value="5">T5</option>
                        </select>
                    </div>

                    <div class="mt-3 text-center">
                        <div id="selectedStudentAlert" class="alert alert-info d-none small mb-2"><i class="fas fa-check-circle"></i> Dipilih: <strong id="selectedStudentText"></strong></div>
                        <button id="confirmBtn" class="btn btn-success btn-sm" onclick="confirmBooking()"> <i class="fas fa-check"></i> Sahkan Tempahan</button>
                    </div>
                </div>

                <div class="col-md-4">
                    <h6 class="mb-2">Senarai Pelajar</h6>
                    <div id="studentList" class="list-group">
                        <div class="text-center text-muted py-4"><i class="fas fa-inbox"></i> Pilih jantina dan tingkatan</div>
                    </div>
                </div>

                <div class="col-md-4">
                    <h6 class="mb-2">Senarai Tempahan</h6>
                    <div class="d-flex justify-content-between mb-2">
                        <div>
                            <input id="selectAllCheckbox" type="checkbox" class="form-check-input" onchange="toggleSelectAll(this.checked)"> <label class="form-check-label small ms-1">Pilih Semua</label>
                        </div>
                        <div>
                            <button id="bulkDeleteBtn" class="btn btn-danger btn-sm d-none" onclick="openAdminModalForBulkDelete()" disabled aria-hidden="true"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div id="bookedList" class="list-group" style="max-height:420px;overflow:auto">
                        <div class="text-center text-muted py-4"><i class="fas fa-inbox"></i> Tiada tempahan</div>
                    </div>
                </div>
            </div>

            <!-- admin import moved to footer -->
        </div>
    </div>

    <!-- Admin modals -->
    <div class="modal fade" id="adminModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 id="adminModalTitle" class="modal-title">Pengesahan Admin</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div id="adminModalBody" class="modal-body"><label class="form-label small">Kata Laluan Admin:</label><input id="adminPassword" class="form-control form-control-sm" type="password"></div><div id="adminModalFooter" class="modal-footer"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Batal</button><button class="btn btn-danger btn-sm" onclick="deleteAfterAuth()">Padam</button></div></div></div></div>

    <div class="modal fade" id="adminImportModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Import Data Pelajar</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="importMessage" class="alert mb-3" style="display:none"></div>
            <div id="adminImportPasswordContainer">
                <label class="form-label small">Kata Laluan Admin:</label>
                <input id="adminImportPassword" class="form-control form-control-sm mb-2" type="password">
            </div>
            <div id="adminImportLoggedInNotice" class="alert alert-info mb-2" style="display:none">Admin sudah log masuk â€” tidak perlu kata laluan.</div>
            <label class="form-label small">Pilih Fail CSV</label>
            <input id="csvImportFile" class="form-control form-control-sm mb-2" type="file" accept=".csv" onchange="previewImportCSV()">
                <div id="importPreviewSection" style="display:none"><div class="table-responsive"><table class="table table-sm table-bordered"><thead id="importPreviewHead"></thead><tbody id="importPreviewBody"></tbody></table></div><small id="importRowCount" class="text-muted"></small></div></div><div class="modal-footer"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Batal</button><button id="confirmImportBtn" class="btn btn-danger btn-sm" onclick="confirmImportStudents()" disabled>Tukar Data Pelajar</button></div></div></div></div>

            <div class="modal fade" id="editJourneyModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Edit Perjalanan</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><label class="form-label small">Keterangan Perjalanan</label><input id="editJourneyText" class="form-control form-control-sm mb-2" type="text"><label class="form-label small">Tarikh / Nota (optional)</label><input id="editJourneyDate" class="form-control form-control-sm mb-2" type="text"><small class="text-muted">Contoh: Khamis, 20 Nov 2025</small></div><div class="modal-footer"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Batal</button><button class="btn btn-primary btn-sm" onclick="openAdminModalForEditConfirm()">Simpan</button></div></div></div></div>

            <!-- Footer: admin icon placed here -->
    <style>
        #adminFooterBtn{position:fixed;right:14px;bottom:14px;z-index:1050}
        #adminFooterBtn .btn{width:40px;height:40px;border-radius:50%;padding:0;display:inline-flex;align-items:center;justify-content:center}
        #adminFooterBtn .btn i{font-size:14px}
    </style>
        <div id="adminFooterBtn">
        <span id="adminStatus" class="badge bg-secondary me-2" style="font-size:0.75rem;vertical-align:middle">Admin: Tidak Log Masuk</span>
        <button id="adminLoginBtn" class="btn btn-primary shadow" title="Admin" onclick="openAdminLoginModal()">
            <i class="fas fa-user-lock" style="font-size:14px;color:#fff"></i>
        </button>
        <button id="footerDownloadBtn" class="btn btn-info shadow ms-2" title="Muat Turun" onclick="downloadSenarai()" disabled style="margin-left:8px;">
            <i class="fas fa-download" style="font-size:14px;color:#fff"></i>
        </button>
        <button id="footerBulkDeleteBtn" class="btn btn-danger shadow ms-2" title="Padam Terpilih" onclick="openAdminModalForBulkDelete()" disabled style="margin-left:8px;">
            <i class="fas fa-trash" style="font-size:14px;color:#fff"></i>
        </button>
        <button id="footerImportBtn" class="btn btn-warning shadow ms-2" title="Import CSV (Admin)" onclick="openAdminImportModal()" style="margin-left:8px;">
            <i class="fas fa-file-upload" style="font-size:14px;color:#fff"></i>
        </button>
        <button id="footerEditJourneyBtn" class="btn btn-secondary shadow ms-2" title="Edit Perjalanan" onclick="openAdminModalForEdit()" aria-label="Edit Perjalanan" style="margin-left:8px;">
            <i class="fas fa-pen" style="font-size:14px;color:#fff"></i>
        </button>
        <button id="adminLogoutBtn" class="btn btn-danger shadow d-none ms-2" title="Log Keluar" onclick="adminLogout()" style="margin-left:6px; margin-top:6px;">
            <i class="fas fa-power-off" style="font-size:14px;color:#fff"></i>
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Minimal, cleaned app script
        const BUS_CAPACITY = 44;
        const MAX_BUSES = 2;
        const TOTAL_CAPACITY = BUS_CAPACITY * MAX_BUSES;
        const ADMIN_PASSWORD = 'power@123!';

        let allStudentsData = [];
        let filteredStudents = [];
        let selectedStudent = null;
        let bookings = {};
        let selectedBulk = new Set();
        let pendingDeleteList = [];
        let pendingJourneyEdit = null;
        let isAdmin = false;

        function showMessage(text, type='info'){
            const el = document.getElementById('message'); el.textContent = text; el.className = 'alert alert-' + type; el.style.display='block'; setTimeout(()=>el.style.display='none',3000);
        }

        function formatName(name){ if(!name) return ''; let r = name.toLowerCase().trim().split(/\s+/).map(w=> w.split('-').map(p=> p ? p.split("'").map(s=> s? s.charAt(0).toUpperCase()+s.slice(1):s).join("'") : p).join('-')).join(' '); r=r.replace(/\b(Bin|Binti)\b/gi,m=>m.toLowerCase()); return r; }

        function loadStudentsDataFromStorage(){ const s = localStorage.getItem('studentData'); if(s) { try{ allStudentsData = JSON.parse(s); return true; }catch(e){ console.error(e); } } return false; }
        function saveStudentsDataToStorage(){ localStorage.setItem('studentData', JSON.stringify(allStudentsData)); }
        async function loadStudentsData(){ if(loadStudentsDataFromStorage()) return; try{ const resp = await fetch('students_data.json'); if(!resp.ok) throw new Error('load failed'); allStudentsData = await resp.json(); saveStudentsDataToStorage(); }catch(e){ console.error(e); showMessage('Gagal muat data', 'danger'); } }

        function loadBookings(){ const s = localStorage.getItem('busBookings'); if(s) bookings = JSON.parse(s); }
        function saveBookings(){ localStorage.setItem('busBookings', JSON.stringify(bookings)); }
        function loadJourneyHeader(){ const s = localStorage.getItem('journeyHeader'); if(!s) return; const d=JSON.parse(s); const h=document.getElementById('journeyHeader'); h.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${d.text}<br><small class="text-muted">ðŸ“… ${d.date}</small>`; }
        function saveJourneyHeader(text,date){ localStorage.setItem('journeyHeader', JSON.stringify({text,date})); const h=document.getElementById('journeyHeader'); if(h) h.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${text}<br><small class="text-muted">ðŸ“… ${date}</small>`; }

        function updateAdminUI(){ const status=document.getElementById('adminStatus'); const l=document.getElementById('adminLoginBtn'); const o=document.getElementById('adminLogoutBtn'); if(isAdmin){ status.textContent='Admin: Log Masuk'; status.className='badge bg-success me-2'; l.classList.add('d-none'); o.classList.remove('d-none'); } else { status.textContent='Admin: Tidak Log Masuk'; status.className='badge bg-secondary me-2'; l.classList.remove('d-none'); o.classList.add('d-none'); } }

        function openAdminLoginModal(){ document.getElementById('adminPassword').value=''; document.getElementById('adminModalTitle').textContent='Log Masuk Admin'; document.getElementById('adminModalBody').innerHTML = '<label class="form-label small">Kata Laluan Admin:</label><input id="adminPassword" class="form-control form-control-sm" type="password">'; document.getElementById('adminModalFooter').innerHTML = '<button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Batal</button><button class="btn btn-primary btn-sm" onclick="doAdminLogin()">Log Masuk</button>'; new bootstrap.Modal(document.getElementById('adminModal')).show(); }
        function doAdminLogin(){ const p = document.getElementById('adminPassword').value; if(p!==ADMIN_PASSWORD){ showMessage('Kata laluan salah','danger'); return; } isAdmin=true; updateAdminUI(); bootstrap.Modal.getInstance(document.getElementById('adminModal')).hide(); showMessage('Berjaya log masuk','success'); }
        function adminLogout(){ isAdmin=false; updateAdminUI(); showMessage('Admin log keluar','info'); }

        function updateStudentsByFilter(){ const g=document.getElementById('genderFilter').value; const t=document.getElementById('classFilter').value; if(!g||!t){ filteredStudents=[]; updateStudentList(); return; } filteredStudents = allStudentsData.filter(s=>s.jantina===g && s.tingkatan===t); filteredStudents.sort((a,b)=>a.nama.localeCompare(b.nama)); updateStudentList(); }

        function updateStudentList(){ const list=document.getElementById('studentList'); const g=document.getElementById('genderFilter').value; const t=document.getElementById('classFilter').value; if(!g||!t){ list.innerHTML='<div class="text-center text-muted py-4"><i class="fas fa-inbox"></i> Pilih jantina dan tingkatan</div>'; return; } if(filteredStudents.length===0){ list.innerHTML='<div class="text-center text-muted py-4"><i class="fas fa-inbox"></i> Tiada pelajar</div>'; return; } list.innerHTML=''; filteredStudents.forEach(s=>{ const item=document.createElement('div'); item.className='list-group-item d-flex align-items-center'; const r=document.createElement('input'); r.type='radio'; r.className='form-check-input me-2'; r.name='studentSelection'; r.value=s.nama; r.checked = s.nama===selectedStudent; const booked = !!bookings[s.nama]; r.disabled = booked; r.onchange = ()=>selectStudent(s.nama); const lbl=document.createElement('label'); lbl.className='mb-0 small form-check-label flex-grow-1'; lbl.textContent = formatName(s.nama); lbl.onclick = ()=>{ if(!r.disabled){ r.checked=true; selectStudent(s.nama);} }; item.appendChild(r); item.appendChild(lbl); if(booked){ const b=document.createElement('span'); b.className='badge bg-warning text-dark ms-2 small'; b.textContent='Sudah menempah'; item.appendChild(b);} list.appendChild(item); }); }

        function selectStudent(name){ selectedStudent=name; const alert=document.getElementById('selectedStudentAlert'); const text=document.getElementById('selectedStudentText'); text.textContent=formatName(name); const btn=document.getElementById('confirmBtn'); if(bookings[name]){ alert.className='alert alert-warning small'; btn.disabled=true; } else { alert.className='alert alert-info small'; btn.disabled=false; } alert.classList.remove('d-none'); updateStudentList(); }

        function confirmBooking(){ if(!selectedStudent){ showMessage('Sila pilih pelajar','danger'); return; } if(bookings[selectedStudent]){ showMessage('Sudah menempah','warning'); return; } if(Object.keys(bookings).length>=TOTAL_CAPACITY){ showMessage('Kapasiti penuh','danger'); return; } bookings[selectedStudent]=true; saveBookings(); showMessage('Tempahan disahkan','success'); selectedStudent=null; updateStudentList(); updateBookedList(); }

        function updateBookedList(){ const el=document.getElementById('bookedList'); const names=Object.keys(bookings); if(names.length===0){ el.innerHTML='<div class="text-center text-muted py-4"><i class="fas fa-inbox"></i> Tiada tempahan</div>'; document.getElementById('bulkDeleteBtn').disabled=true; const footDownload = document.getElementById('footerDownloadBtn'); if(footDownload) footDownload.disabled = true; updateSelectAllCheckbox(); return; } el.innerHTML=''; const bus1=names.slice(0,BUS_CAPACITY); const bus2=names.slice(BUS_CAPACITY); if(bus1.length){ const h=document.createElement('div'); h.className='list-group-item bg-light'; h.textContent=`Bas 1 (${bus1.length}/${BUS_CAPACITY})`; el.appendChild(h); bus1.forEach((n,i)=>{ const it=document.createElement('div'); it.className='list-group-item d-flex align-items-center'; const cb=document.createElement('input'); cb.type='checkbox'; cb.className='form-check-input me-2'; cb.checked=selectedBulk.has(n); cb.onchange=()=>toggleBulkSelect(n,cb.checked); const span=document.createElement('span'); span.className='small text-primary'; span.textContent=`${i+1}. ${formatName(n)}`; it.appendChild(cb); it.appendChild(span); el.appendChild(it); }); }
            if(bus2.length){ const h=document.createElement('div'); h.className='list-group-item bg-light mt-2'; h.textContent=`Bas 2 (${bus2.length}/${BUS_CAPACITY})`; el.appendChild(h); bus2.forEach((n,i)=>{ const it=document.createElement('div'); it.className='list-group-item d-flex align-items-center'; const cb=document.createElement('input'); cb.type='checkbox'; cb.className='form-check-input me-2'; cb.checked=selectedBulk.has(n); cb.onchange=()=>toggleBulkSelect(n,cb.checked); const span=document.createElement('span'); span.className='small text-primary'; span.textContent=`${i+1}. ${formatName(n)}`; it.appendChild(cb); it.appendChild(span); el.appendChild(it); }); }
            // sync both top (hidden) and footer bulk delete buttons + footer download
            const topBulk = document.getElementById('bulkDeleteBtn');
            const footBulk = document.getElementById('footerBulkDeleteBtn');
            const footDownload = document.getElementById('footerDownloadBtn');
            if(topBulk) topBulk.disabled = selectedBulk.size===0;
            if(footBulk) footBulk.disabled = selectedBulk.size===0;
            if(footDownload) footDownload.disabled = names.length===0;
            updateSelectAllCheckbox(); }

        function toggleBulkSelect(name,checked){ if(checked) selectedBulk.add(name); else selectedBulk.delete(name); const topBulk = document.getElementById('bulkDeleteBtn'); const footBulk = document.getElementById('footerBulkDeleteBtn'); if(topBulk) topBulk.disabled = selectedBulk.size===0; if(footBulk) footBulk.disabled = selectedBulk.size===0; updateSelectAllCheckbox(); }
        function toggleSelectAll(checked){ const names=Object.keys(bookings); if(checked) names.forEach(n=>selectedBulk.add(n)); else selectedBulk.clear(); updateBookedList(); const footBulk = document.getElementById('footerBulkDeleteBtn'); if(footBulk) footBulk.disabled = selectedBulk.size===0; }
        function updateSelectAllCheckbox(){ const cb=document.getElementById('selectAllCheckbox'); if(!cb) return; const names=Object.keys(bookings); cb.checked = names.length>0 && selectedBulk.size===names.length; }

        function downloadSenarai(){ const names=Object.keys(bookings); if(names.length===0){ showMessage('Tiada tempahan','warning'); return; } const header=document.getElementById('journeyHeader').innerText.trim(); let content='SENARAI TEMPAHAN\n\n'+header+'\n\n'; names.forEach((n,i)=> content+=`${i+1}. ${formatName(n)}\n`); const a=document.createElement('a'); a.href='data:text/plain;charset=utf-8,'+encodeURIComponent(content); a.download='Senarai_Tempahan_Bas.txt'; document.body.appendChild(a); a.click(); a.remove(); showMessage('Dimuat turun','success'); }

        function openAdminModalForBulkDelete(){
            if (selectedBulk.size === 0) return;
            pendingDeleteList = Array.from(selectedBulk);
            // If admin already logged in, skip password modal and perform deletion after confirmation
            if (isAdmin) {
                const cnt = pendingDeleteList.length;
                if (!confirm(`Padam ${cnt} tempahan terpilih?`)) return;
                deleteAfterAuth();
                return;
            }
            document.getElementById('adminPassword').value = '';
            new bootstrap.Modal(document.getElementById('adminModal')).show();
        }
        function deleteAfterAuth(){ if(!isAdmin){ const p=document.getElementById('adminPassword').value; if(p!==ADMIN_PASSWORD){ showMessage('Kata laluan salah','danger'); return; } } if(pendingDeleteList.length>0){ let c=0; pendingDeleteList.forEach(n=>{ if(bookings[n]){ delete bookings[n]; c++; } }); saveBookings(); selectedBulk.clear(); pendingDeleteList=[]; updateBookedList(); showMessage(`${c} tempahan dipadam`,'success'); bootstrap.Modal.getInstance(document.getElementById('adminModal')).hide(); return; } showMessage('Tiada yang dipadam','info'); }

        function openAdminModalForEdit(){
            // populate modal inputs from saved journeyHeader if present
            const stored = localStorage.getItem('journeyHeader');
            let text = '';
            let date = '';
            if(stored){ try{ const d = JSON.parse(stored); text = d.text||''; date = d.date||''; }catch(e){}
            }
            document.getElementById('editJourneyText').value = text;
            document.getElementById('editJourneyDate').value = date;
            new bootstrap.Modal(document.getElementById('editJourneyModal')).show();
        }

        function openAdminModalForEditConfirm(){
            const text = document.getElementById('editJourneyText').value.trim();
            const date = document.getElementById('editJourneyDate').value.trim();
            if(!text){ showMessage('Sila masukkan keterangan perjalanan','danger'); return; }
            // If admin logged in, save directly
            if(isAdmin){ saveJourneyHeader(text,date); bootstrap.Modal.getInstance(document.getElementById('editJourneyModal')).hide(); showMessage('Perjalanan dikemaskini','success'); return; }
            // require admin auth: store pending and show admin modal
            pendingJourneyEdit = { text, date };
            // hide edit modal while asking for admin password
            const editModalEl = document.getElementById('editJourneyModal');
            const editModalInst = bootstrap.Modal.getInstance(editModalEl);
            if(editModalInst) editModalInst.hide();
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminModalTitle').textContent = 'Pengesahan untuk Kemaskini';
            document.getElementById('adminModalBody').innerHTML = '<label class="form-label small">Kata Laluan Admin:</label><input id="adminPassword" class="form-control form-control-sm" type="password">';
            document.getElementById('adminModalFooter').innerHTML = '<button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Batal</button><button class="btn btn-primary btn-sm" onclick="saveJourneyEditAfterAuth()">Sahkan & Simpan</button>';
            new bootstrap.Modal(document.getElementById('adminModal')).show();
        }

        function saveJourneyEditAfterAuth(){
            if(!isAdmin){ const p = document.getElementById('adminPassword').value; if(p!==ADMIN_PASSWORD){ showMessage('Kata laluan salah','danger'); return; } isAdmin = true; updateAdminUI(); }
            if(pendingJourneyEdit){ saveJourneyHeader(pendingJourneyEdit.text,pendingJourneyEdit.date); pendingJourneyEdit = null; saveBookings(); bootstrap.Modal.getInstance(document.getElementById('adminModal')).hide(); bootstrap.Modal.getInstance(document.getElementById('editJourneyModal')).hide(); showMessage('Perjalanan dikemaskini','success'); }
        }

        function openAdminImportModal(){
            document.getElementById('adminImportPassword').value = '';
            document.getElementById('csvImportFile').value = '';
            document.getElementById('importPreviewSection').style.display = 'none';
            document.getElementById('confirmImportBtn').disabled = true;
            const pwContainer = document.getElementById('adminImportPasswordContainer');
            const loggedNote = document.getElementById('adminImportLoggedInNotice');
            if(isAdmin){
                if(pwContainer) pwContainer.style.display = 'none';
                if(loggedNote) loggedNote.style.display = 'block';
            } else {
                if(pwContainer) pwContainer.style.display = 'block';
                if(loggedNote) loggedNote.style.display = 'none';
            }
            new bootstrap.Modal(document.getElementById('adminImportModal')).show();
        }
        function previewImportCSV(){ const f=document.getElementById('csvImportFile').files[0]; if(!f) return; const r=new FileReader(); r.onload=e=>{ const csv=e.target.result; const lines=csv.split(/\r?\n/).filter(Boolean); if(lines.length<2){ document.getElementById('importMessage').textContent='CSV tidak sah'; document.getElementById('importMessage').className='alert alert-danger'; document.getElementById('importMessage').style.display='block'; return; } const headers=lines[0].split(',').map(h=>h.trim().toUpperCase()); const rows=[]; for(let i=1;i<lines.length;i++){ const vals=lines[i].split(','); const obj={}; headers.forEach((h,idx)=> obj[h]= (vals[idx]||'').trim()); rows.push(obj); } // preview
            const head=document.getElementById('importPreviewHead'); const body=document.getElementById('importPreviewBody'); head.innerHTML=''; body.innerHTML=''; const tr=document.createElement('tr'); headers.forEach(h=>{ const th=document.createElement('th'); th.textContent=h; tr.appendChild(th); }); head.appendChild(tr); rows.slice(0,5).forEach(rw=>{ const tr2=document.createElement('tr'); headers.forEach(h=>{ const td=document.createElement('td'); td.textContent = rw[h]||''; tr2.appendChild(td); }); body.appendChild(tr2); }); document.getElementById('importRowCount').textContent=`Jumlah baris: ${rows.length}`; document.getElementById('importPreviewSection').style.display='block'; document.getElementById('confirmImportBtn').disabled=false; document.getElementById('importMessage').style.display='none'; }; r.readAsText(f,'utf-8'); }

        function confirmImportStudents(){ if(!isAdmin){ const p=document.getElementById('adminImportPassword').value; if(p!==ADMIN_PASSWORD){ document.getElementById('importMessage').textContent='Kata laluan salah'; document.getElementById('importMessage').className='alert alert-danger'; document.getElementById('importMessage').style.display='block'; return; } } const f=document.getElementById('csvImportFile').files[0]; if(!f) return; const r=new FileReader(); r.onload=e=>{ const csv=e.target.result; const lines=csv.split(/\r?\n/).filter(Boolean); const headers=lines[0].split(',').map(h=>h.trim().toUpperCase()); const rows=[]; for(let i=1;i<lines.length;i++){ const vals=lines[i].split(','); const obj={}; headers.forEach((h,idx)=> obj[h]= (vals[idx]||'').trim()); rows.push(obj); } allStudentsData = rows.map(row=>({ nama: row['NAMA']||'', jantina: row['JANTINA']||'', tingkatan: row['TINGKATAN']||'' })); saveStudentsDataToStorage(); bookings={}; saveBookings(); selectedBulk.clear(); updateStudentsByFilter(); updateBookedList(); bootstrap.Modal.getInstance(document.getElementById('adminImportModal')).hide(); showMessage(`Diimport ${allStudentsData.length} pelajar`,'success'); }; r.readAsText(f,'utf-8'); }

        document.addEventListener('DOMContentLoaded', async ()=>{ loadBookings(); loadJourneyHeader(); await loadStudentsData(); updateAdminUI(); updateStudentList(); updateBookedList(); });
    </script>
</body>
</html>