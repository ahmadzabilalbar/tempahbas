<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tempahan Bas Pulang Bermalam</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>body{min-height:100vh} .small-btn{padding:.28rem .5rem;font-size:.8rem}</style>
</head>
<body class="bg-light">
    <div class="container py-3">
        <div class="bg-white rounded shadow p-3">
            <h1 class="h4 text-center mb-3"><i class="fas fa-bus"></i> Tempahan Bas Pulang Bermalam</h1>

            <div id="adminToolsHeader" class="d-flex justify-content-end gap-1 mb-3" style="display:none">
                <button id="adminLoginHeaderBtn" class="btn btn-sm p-1" title="Admin" onclick="openAdminLoginModal()" style="width:28px;height:28px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:12px">
                    <i class="fas fa-user-lock"></i>
                </button>
                <button id="footerSettingsHeaderBtn" class="btn btn-sm p-1" title="Tetapan Bas" onclick="openAdminSettingsModal()" style="width:28px;height:28px;border-radius:50%;display:none;align-items:center;justify-content:center;font-size:12px">
                    <i class="fas fa-cog"></i>
                </button>
                <button id="footerEditJourneyHeaderBtn" class="btn btn-sm p-1" title="Edit Perjalanan" onclick="openAdminModalForEdit()" style="width:28px;height:28px;border-radius:50%;display:none;align-items:center;justify-content:center;font-size:12px">
                    <i class="fas fa-pen"></i>
                </button>
                <button id="footerDownloadHeaderBtn" class="btn btn-sm p-1" title="Muat Turun" onclick="downloadSenarai()" disabled style="width:28px;height:28px;border-radius:50%;display:none;align-items:center;justify-content:center;font-size:12px">
                    <i class="fas fa-download"></i>
                </button>
                <button id="footerDownloadNonBookedHeaderBtn" class="btn btn-sm p-1" title="Muat Turun (Tidak Tempah)" onclick="downloadNonBooked()" disabled style="width:28px;height:28px;border-radius:50%;display:none;align-items:center;justify-content:center;font-size:12px">
                    <i class="fas fa-user-clock"></i>
                </button>
                <button id="footerWhatsAppHeaderBtn" class="btn btn-sm p-1" title="Eksport ke WhatsApp" onclick="exportWhatsAppBooked()" disabled style="width:28px;height:28px;border-radius:50%;display:none;align-items:center;justify-content:center;font-size:12px">
                    <i class="fab fa-whatsapp"></i>
                </button>
                <button id="footerBulkDeleteHeaderBtn" class="btn btn-sm p-1" title="Padam Terpilih" onclick="openAdminModalForBulkDelete()" disabled style="width:28px;height:28px;border-radius:50%;display:none;align-items:center;justify-content:center;font-size:12px">
                    <i class="fas fa-trash"></i>
                </button>
                <button id="footerImportHeaderBtn" class="btn btn-sm p-1" title="Import CSV (Admin)" onclick="openAdminImportModal()" style="width:28px;height:28px;border-radius:50%;display:none;align-items:center;justify-content:center;font-size:12px">
                    <i class="fas fa-file-upload"></i>
                </button>
                <button id="resetAllHeaderBtn" class="btn btn-sm p-1" title="Reset Semua" onclick="resetAllWithConfirm()" style="width:28px;height:28px;border-radius:50%;display:none;align-items:center;justify-content:center;font-size:12px">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button id="adminLogoutHeaderBtn" class="btn btn-sm p-1 d-none" title="Log Keluar" onclick="adminLogout()" style="width:28px;height:28px;border-radius:50%;display:none;align-items:center;justify-content:center;font-size:12px">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>

            <div id="message" class="alert mb-2" role="alert" style="display:none"></div>

            <div class="text-center mb-3">
                <div id="journeyHeader" class="small text-muted p-2" style="background-color:#fff3cd;border-left:4px solid #ffc107;display:inline-block;border-radius:4px;font-weight:bold">
                    Sila tetapkan perjalanan
                </div>
                
            </div>

            <div class="row g-3">
                <div class="col-md-4">
                    <div class="mb-2">
                        <select id="genderFilter" class="form-select form-select-sm" onchange="updateStudentsByFilter()">
                            <option value="">-- Pilih Jantina --</option>
                            <option value="LELAKI">Lelaki</option>
                            <option value="PEREMPUAN">Perempuan</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <select id="classFilter" class="form-select form-select-sm" onchange="updateStudentsByFilter()">
                            <option value="">-- Pilih Tingkatan --</option>
                            <option value="1">T1</option>
                            <option value="2">T2</option>
                            <option value="3">T3</option>
                            <option value="4">T4</option>
                            <option value="5">T5</option>
                        </select>
                    </div>
                    <div id="studentList" class="list-group mb-3">
                        <div class="text-center text-muted py-4"><i class="fas fa-inbox"></i></div>
                    </div>
                    <div class="text-center">
                        <div id="selectedStudentAlert" class="alert alert-info d-none small mb-2"><i class="fas fa-check-circle"></i> <strong id="selectedStudentText"></strong></div>
                        <button id="confirmBtn" class="btn btn-success btn-sm" onclick="confirmBooking()"> <i class="fas fa-check"></i> Sahkan Tempahan</button>
                    </div>
                </div>

                <div class="col-md-4">
                    <h6 class="mb-2 text-center">Senarai Tempahan</h6>
                    <div class="d-flex justify-content-between mb-2">
                        <div></div>
                    </div>
                    <div id="bookedList" class="list-group" style="max-height:420px;overflow:auto">
                        <div class="text-center text-muted py-4"><i class="fas fa-inbox"></i> Tiada tempahan</div>
                    </div>
                </div>
            </div>

            
        </div>
    </div>

    <!-- Admin modals -->
    <div class="modal fade" id="adminModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 id="adminModalTitle" class="modal-title">Pengesahan Admin</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div id="adminModalBody" class="modal-body"><label class="form-label small">Kata Laluan Admin:</label><input id="adminPassword" class="form-control form-control-sm" type="password"></div><div id="adminModalFooter" class="modal-footer"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Batal</button><button class="btn btn-danger btn-sm" onclick="deleteAfterAuth()">Padam</button></div></div></div></div>

    <div class="modal fade" id="adminImportModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Import Data Pelajar</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="importMessage" class="alert mb-3" style="display:none"></div>
            <div id="adminImportPasswordContainer">
                <label class="form-label small">Kata Laluan Admin:</label>
                <input id="adminImportPassword" class="form-control form-control-sm mb-2" type="password">
            </div>
            <div id="adminImportLoggedInNotice" class="alert alert-info mb-2" style="display:none">Admin sudah log masuk — tidak perlu kata laluan.</div>
            <label class="form-label small">Pilih Fail CSV</label>
            <input id="csvImportFile" class="form-control form-control-sm mb-2" type="file" accept=".csv" onchange="previewImportCSV()">
                <div id="importPreviewSection" style="display:none"><div class="table-responsive"><table class="table table-sm table-bordered"><thead id="importPreviewHead"></thead><tbody id="importPreviewBody"></tbody></table></div><small id="importRowCount" class="text-muted"></small></div></div><div class="modal-footer"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Batal</button><button id="confirmImportBtn" class="btn btn-danger btn-sm" onclick="confirmImportStudents()" disabled>Tukar Data Pelajar</button></div></div></div></div>

            <div class="modal fade" id="editJourneyModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Edit Perjalanan</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><label class="form-label small">Arah Perjalanan</label><select id="editJourneyDirection" class="form-select form-select-sm mb-3" onchange="updateJourneyDestinationOptions()"><option value="">-- Pilih Arah --</option><option value="1">Perjalanan dari MTSD ke Sungai Petani/Gurun/Alor Setar</option><option value="2">Perjalanan dari Sungai Petani/Gurun/Alor Setar ke MTSD</option></select><label class="form-label small">Tarikh dan Masa</label><input id="editJourneyDateTime" class="form-control form-control-sm mb-2" type="datetime-local"></div><div class="modal-footer"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Batal</button><button class="btn btn-primary btn-sm" onclick="openAdminModalForEditConfirm()">Simpan</button></div></div></div></div>

            <div class="modal fade" id="adminSettingsModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Tetapan Aplikasi</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><label class="form-label small">Jumlah Bas</label><input id="settingsBusCount" type="number" min="1" max="10" class="form-control form-control-sm mb-2"><div class="form-check form-switch mb-2"><input id="settingsSegregation" class="form-check-input" type="checkbox"><label class="form-check-label">Aktifkan Segregasi Jantina</label></div><small class="text-muted">Ubah jumlah bas akan mengubah kapasiti total (Kapasiti setiap bas: 44).</small></div><div class="modal-footer"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Batal</button><button class="btn btn-primary btn-sm" onclick="saveAdminSettings()">Simpan</button></div></div></div></div>

            

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        
        const BUS_CAPACITY = 44;
        // number of buses (configurable)
        let busCount = 2;
        // Admin password reconstructed from three scrambled chunks.
        // Note: this only obscures the string in the source; it does not secure it.
        function reverseString(s){ return s.split('').reverse().join(''); }
        const _chunk1 = 'wop';   // scrambled for 'pow'
        const _chunk2 = '@re';   // scrambled for 'er@'
        const _chunk3 = '!321';  // scrambled for '123!'
        const SECRET_PASS = reverseString(_chunk1) + reverseString(_chunk2) + reverseString(_chunk3);

        let allStudentsData = [];
        let filteredStudents = [];
        let selectedStudent = null;
        let bookings = {};
        let selectedBulk = new Set();
        let pendingDeleteList = [];
        let pendingJourneyEdit = null;
        let isAdmin = false;
        let pendingSettingsOpen = false;
        // Bus segregation setting (persisted)
        let busSegregationEnabled = true;

        function loadSettings(){
            const s = localStorage.getItem('busSegregationEnabled');
            // default segregation disabled
            busSegregationEnabled = s === null ? false : (s === 'true');
            const bc = localStorage.getItem('busCount');
            busCount = bc ? parseInt(bc,10) || 2 : 2;
        }

        function saveSettings(){
            localStorage.setItem('busSegregationEnabled', busSegregationEnabled);
            localStorage.setItem('busCount', String(busCount));
            // if only 1 bus, ensure settings checkbox in modal is disabled when open
            const elSeg = document.getElementById('settingsSegregation');
            if(elSeg) elSeg.disabled = (busCount === 1);
        }

        

        function openAdminSettingsModal(){
            if(!isAdmin){ pendingSettingsOpen = true; openAdminLoginModal(); return; }
            const elCount = document.getElementById('settingsBusCount');
            const elSeg = document.getElementById('settingsSegregation');
            if(elCount) elCount.value = busCount;
            if(elSeg) elSeg.checked = busSegregationEnabled;
            // if only 1 bus, disable segregation checkbox
            if(elSeg) elSeg.disabled = (busCount === 1);
            new bootstrap.Modal(document.getElementById('adminSettingsModal')).show();
        }

        function saveAdminSettings(){
            if(!isAdmin){ showMessage('Perlu log masuk sebagai admin','danger'); return; }
            const elCount = document.getElementById('settingsBusCount');
            const elSeg = document.getElementById('settingsSegregation');
            const val = parseInt(elCount.value,10);
            if(isNaN(val) || val < 1){ showMessage('Sila masukkan bilangan bas yang sah','danger'); return; }
            const newBusCount = Math.min(10, val);
            const currentBookings = Object.keys(bookings).length;
            const newTotal = BUS_CAPACITY * newBusCount;
            if(currentBookings > newTotal){
                const overflow = currentBookings - newTotal;
                if(!confirm(`Mengurangkan jumlah bas kepada ${newBusCount} akan menyebabkan ${overflow} tempahan melebihi kapasiti (${newTotal}). Teruskan?`)){
                    return;
                }
            }
            busCount = newBusCount;
            // if only 1 bus, force segregation off
            if(busCount === 1){
                busSegregationEnabled = false;
            } else {
                busSegregationEnabled = !!elSeg.checked;
            }
            saveSettings();
            updateBookedList();
            // hide settings modal robustly (create instance if needed)
            const settingsEl = document.getElementById('adminSettingsModal');
            const settingsInst = bootstrap.Modal.getInstance(settingsEl) || bootstrap.Modal.getOrCreateInstance(settingsEl);
            if(settingsInst) settingsInst.hide();
            showMessage('Tetapan disimpan','success');
        }

        function showMessage(text, type='info'){
            const el = document.getElementById('message'); el.textContent = text; el.className = 'alert alert-' + type; el.style.display='block'; setTimeout(()=>el.style.display='none',3000);
        }

        function formatName(name){ 
            if(!name) return ''; 
            let r = name.toLowerCase().trim().split(/\s+/).map(w=> {
                return w.split('-').map(p=> {
                    if(!p) return p;
                    return p.split("'").map((s,idx)=> {
                        if(!s) return s;
                        // If this is the first segment (before apostrophe) -> Title case
                        // If the original chunk starts with an apostrophe (p[0] === "'") then
                        // the segment after that leading apostrophe should be Title case too (e.g. "'Aqeef")
                        if(idx === 0) return s.charAt(0).toUpperCase() + s.slice(1);
                        if(p.charAt(0) === "'") return s.charAt(0).toUpperCase() + s.slice(1);
                        // otherwise (apostrophe in middle) keep lowercase segment (e.g. Mus'ab)
                        return s;
                    }).join("'");
                }).join('-');
            }).join(' '); 
            r=r.replace(/\b(Bin|Binti)\b/gi,m=>m.toLowerCase()); 
            return r; 
        }

        function loadStudentsDataFromStorage(){ const s = localStorage.getItem('studentData'); if(s) { try{ allStudentsData = JSON.parse(s); return true; }catch(e){ console.error(e); } } return false; }
        function saveStudentsDataToStorage(){ localStorage.setItem('studentData', JSON.stringify(allStudentsData)); }
        async function loadStudentsData(){ if(loadStudentsDataFromStorage()) return; try{ const resp = await fetch('students_data.json'); if(!resp.ok) throw new Error('load failed'); allStudentsData = await resp.json(); saveStudentsDataToStorage(); }catch(e){ console.error(e); showMessage('Gagal muat data', 'danger'); } }

        function loadBookings(){ const s = localStorage.getItem('busBookings'); if(s) bookings = JSON.parse(s); }
        function saveBookings(){ localStorage.setItem('busBookings', JSON.stringify(bookings)); }
        function loadJourneyHeader(){ const s = localStorage.getItem('journeyHeader'); if(!s) return; const d=JSON.parse(s); const h=document.getElementById('journeyHeader'); if(h) h.innerHTML = `${d.text}<br><small class="text-muted">${d.date}</small>`; }
        function saveJourneyHeader(text,date){ localStorage.setItem('journeyHeader', JSON.stringify({text,date})); const h=document.getElementById('journeyHeader'); if(h) h.innerHTML = `${text}<br><small class="text-muted">${date}</small>`; }

        function updateAdminUI(){ 
            const adminTools = document.getElementById('adminToolsHeader'); 
            const loginBtn = document.getElementById('adminLoginHeaderBtn'); 
            const logoutBtn = document.getElementById('adminLogoutHeaderBtn'); 
            const downloadBtn = document.getElementById('footerDownloadHeaderBtn');
            const deleteBtn = document.getElementById('footerBulkDeleteHeaderBtn');
            const importBtn = document.getElementById('footerImportHeaderBtn');
            const editBtn = document.getElementById('footerEditJourneyHeaderBtn');
            const settingsBtn = document.getElementById('footerSettingsHeaderBtn');
            const nonBookedBtn = document.getElementById('footerDownloadNonBookedHeaderBtn');
            const whatsappBtn = document.getElementById('footerWhatsAppHeaderBtn');
            const resetBtn = document.getElementById('resetAllHeaderBtn');
            if(isAdmin){ 
                adminTools.style.display = 'flex'; 
                loginBtn.style.display = 'none'; 
                logoutBtn.classList.remove('d-none'); 
                logoutBtn.style.display = 'inline-flex';
                if(downloadBtn) downloadBtn.style.display = 'inline-flex';
                if(nonBookedBtn) nonBookedBtn.style.display = 'inline-flex';
                if(whatsappBtn) whatsappBtn.style.display = 'inline-flex';
                if(deleteBtn) deleteBtn.style.display = 'inline-flex';
                if(importBtn) importBtn.style.display = 'inline-flex';
                if(editBtn) editBtn.style.display = 'inline-flex';
                if(settingsBtn) settingsBtn.style.display = 'inline-flex';
                if(resetBtn) resetBtn.style.display = 'inline-flex';
            } else { 
                loginBtn.style.display = 'inline-flex'; 
                logoutBtn.classList.add('d-none');
                logoutBtn.style.display = 'none';
                if(downloadBtn) downloadBtn.style.display = 'none';
                if(nonBookedBtn) nonBookedBtn.style.display = 'none';
                if(whatsappBtn) whatsappBtn.style.display = 'none';
                if(deleteBtn) deleteBtn.style.display = 'none';
                if(importBtn) importBtn.style.display = 'none';
                if(editBtn) editBtn.style.display = 'none';
                if(settingsBtn) settingsBtn.style.display = 'none';
                if(resetBtn) resetBtn.style.display = 'none';
            } 
        }

        function openAdminLoginModal(){ document.getElementById('adminPassword').value=''; document.getElementById('adminModalTitle').textContent='Log Masuk Admin'; document.getElementById('adminModalBody').innerHTML = '<label class="form-label small">Kata Laluan Admin:</label><input id="adminPassword" class="form-control form-control-sm" type="password">'; document.getElementById('adminModalFooter').innerHTML = '<button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Batal</button><button class="btn btn-primary btn-sm" onclick="doAdminLogin()">Log Masuk</button>'; new bootstrap.Modal(document.getElementById('adminModal')).show(); }
        function doAdminLogin(){ const p = document.getElementById('adminPassword').value; if(p!==SECRET_PASS){ showMessage('Kata laluan salah','danger'); return; } isAdmin=true; updateAdminUI(); const adminModalEl = document.getElementById('adminModal'); const adminModalInst = bootstrap.Modal.getInstance(adminModalEl) || bootstrap.Modal.getOrCreateInstance(adminModalEl); if(adminModalInst) adminModalInst.hide(); showMessage('Berjaya log masuk','success'); if(pendingSettingsOpen){ pendingSettingsOpen = false; openAdminSettingsModal(); } }
        function adminLogout(){ isAdmin=false; updateAdminUI(); showMessage('Admin log keluar','info'); }

        function resetAllWithConfirm(){
            if(!confirm('Reset semua tempahan dan perjalanan?')) return;
            bookings = {};
            saveBookings();
            selectedBulk.clear();
            localStorage.removeItem('journeyHeader');
            const h = document.getElementById('journeyHeader');
            if(h) h.innerHTML = `Sila tetapkan perjalanan`;
            updateBookedList();
            updateStudentList();
            showMessage('Semua data di-reset','success');
        }

        function updateStudentsByFilter(){ const g=document.getElementById('genderFilter').value; const t=document.getElementById('classFilter').value; if(!g||!t){ filteredStudents=[]; updateStudentList(); return; } filteredStudents = allStudentsData.filter(s=>s.jantina===g && s.tingkatan===t); filteredStudents.sort((a,b)=>a.nama.localeCompare(b.nama)); updateStudentList(); }

        function updateStudentList(){ const list=document.getElementById('studentList'); const g=document.getElementById('genderFilter').value; const t=document.getElementById('classFilter').value; if(!g||!t){ list.innerHTML='<div class="text-center text-muted py-4"><i class="fas fa-inbox"></i> Pilih jantina dan tingkatan</div>'; return; } if(filteredStudents.length===0){ list.innerHTML='<div class="text-center text-muted py-4"><i class="fas fa-inbox"></i> Tiada pelajar</div>'; return; } list.innerHTML=''; filteredStudents.forEach(s=>{ const item=document.createElement('div'); item.className='list-group-item d-flex align-items-center'; const r=document.createElement('input'); r.type='radio'; r.className='form-check-input me-2'; r.name='studentSelection'; r.value=s.nama; r.checked = s.nama===selectedStudent; const booked = !!bookings[s.nama]; r.disabled = booked; r.onchange = ()=>selectStudent(s.nama); const lbl=document.createElement('label'); lbl.className='mb-0 small form-check-label flex-grow-1'; lbl.textContent = formatName(s.nama); lbl.onclick = ()=>{ if(!r.disabled){ r.checked=true; selectStudent(s.nama);} }; item.appendChild(r); item.appendChild(lbl); if(booked){ const b=document.createElement('span'); b.className='badge bg-warning text-dark ms-2 small'; b.textContent='Sudah menempah'; item.appendChild(b);} list.appendChild(item); }); }

        function selectStudent(name){ selectedStudent=name; const alert=document.getElementById('selectedStudentAlert'); const text=document.getElementById('selectedStudentText'); text.textContent=formatName(name); const btn=document.getElementById('confirmBtn'); if(bookings[name]){ alert.className='alert alert-warning small'; btn.disabled=true; } else { alert.className='alert alert-info small'; btn.disabled=false; } alert.classList.remove('d-none'); updateStudentList(); }

        function confirmBooking(){ if(!selectedStudent){ showMessage('Sila pilih pelajar','danger'); return; } if(bookings[selectedStudent]){ showMessage('Sudah menempah','warning'); return; } if(Object.keys(bookings).length>= (BUS_CAPACITY * busCount) ){ showMessage('Kapasiti penuh','danger'); return; } bookings[selectedStudent]=true; saveBookings(); showMessage('Tempahan disahkan','success'); selectedStudent=null; updateStudentList(); updateBookedList(); }

        function updateBookedList(){ 
            const el=document.getElementById('bookedList'); 
            const names=Object.keys(bookings);
            
            // Determine bus assignment depending on segregation setting
            let bus1final = [];
            let bus2final = [];
            if(busSegregationEnabled){
                const lelaki = names.filter(n => {
                    const student = allStudentsData.find(s => s.nama === n);
                    return student?.jantina === 'LELAKI';
                });
                const perempuan = names.filter(n => {
                    const student = allStudentsData.find(s => s.nama === n);
                    return student?.jantina === 'PEREMPUAN';
                });

                // Fill Bus 1 with Lelaki, overflow to Bus 2
                const bus1 = lelaki.slice(0, BUS_CAPACITY);
                const lelakiremainder = lelaki.slice(BUS_CAPACITY);

                // Fill Bus 2 with Perempuan, plus any Lelaki overflow if space available
                let bus2 = perempuan.slice(0, BUS_CAPACITY - lelakiremainder.length);
                bus2 = bus2.concat(lelakiremainder.slice(0, BUS_CAPACITY - bus2.length));

                // Any remaining overflow goes to Bus 1 if space
                const perempuanoverflow = perempuan.slice(BUS_CAPACITY - lelakiremainder.length);
                const bus1overflow = perempuanoverflow.slice(0, BUS_CAPACITY - bus1.length);
                bus1final = bus1.concat(bus1overflow);
                bus2final = bus2;
            } else {
                // Sequential fill (no segregation): fill Bus 1 then Bus 2
                bus1final = names.slice(0, BUS_CAPACITY);
                bus2final = names.slice(BUS_CAPACITY, BUS_CAPACITY * busCount);
            }
            
            if(names.length===0){ 
                el.innerHTML='<div class="text-center text-muted py-4"><i class="fas fa-inbox"></i> Tiada tempahan</div>'; 
                document.getElementById('bulkDeleteBtn').disabled=true; 
                const footDownload = document.getElementById('footerDownloadBtn'); 
                if(footDownload) footDownload.disabled = true; 
                const headerDownload = document.getElementById('footerDownloadHeaderBtn'); 
                if(headerDownload) headerDownload.disabled = true; 
                const headerNonBookedEarly = document.getElementById('footerDownloadNonBookedHeaderBtn');
                if(headerNonBookedEarly) headerNonBookedEarly.disabled = true;
                updateSelectAllCheckbox(); 
                return; 
            } 
            el.innerHTML=''; 
            
            if(bus1final.length){ 
                const h=document.createElement('div'); 
                h.className='list-group-item bg-light'; 
                h.textContent=`Bas 1 (${bus1final.length}/${BUS_CAPACITY})`; 
                el.appendChild(h); 
                bus1final.forEach((n,i)=>{ 
                    const it=document.createElement('div'); 
                    it.className='list-group-item d-flex align-items-center'; 
                    const cb=document.createElement('input'); 
                    cb.type='checkbox'; 
                    cb.className='form-check-input me-2'; 
                    cb.checked=selectedBulk.has(n); 
                    cb.onchange=()=>toggleBulkSelect(n,cb.checked); 
                    const student = allStudentsData.find(s => s.nama === n);
                    const tingkat = student?.tingkatan || '?';
                    const span=document.createElement('span'); 
                    span.className='small text-primary'; 
                    span.textContent=`${i+1}. ${formatName(n)} (F${tingkat})`; 
                    it.appendChild(cb); 
                    it.appendChild(span); 
                    el.appendChild(it); 
                }); 
            }
            if(bus2final.length){ 
                const h=document.createElement('div'); 
                h.className='list-group-item bg-light mt-2'; 
                h.textContent=`Bas 2 (${bus2final.length}/${BUS_CAPACITY})`; 
                el.appendChild(h); 
                bus2final.forEach((n,i)=>{ 
                    const it=document.createElement('div'); 
                    it.className='list-group-item d-flex align-items-center'; 
                    const cb=document.createElement('input'); 
                    cb.type='checkbox'; 
                    cb.className='form-check-input me-2'; 
                    cb.checked=selectedBulk.has(n); 
                    cb.onchange=()=>toggleBulkSelect(n,cb.checked); 
                    const student = allStudentsData.find(s => s.nama === n);
                    const tingkat = student?.tingkatan || '?';
                    const span=document.createElement('span'); 
                    span.className='small text-primary'; 
                    span.textContent=`${i+1}. ${formatName(n)} (F${tingkat})`; 
                    it.appendChild(cb); 
                    it.appendChild(span); 
                    el.appendChild(it); 
                }); 
            }
            // sync all delete and download buttons
            const topBulk = document.getElementById('bulkDeleteBtn');
            const footBulk = document.getElementById('footerBulkDeleteBtn');
            const headerBulk = document.getElementById('footerBulkDeleteHeaderBtn');
            const footDownload = document.getElementById('footerDownloadBtn');
            const headerDownload = document.getElementById('footerDownloadHeaderBtn');
            if(topBulk) topBulk.disabled = selectedBulk.size===0;
            if(footBulk) footBulk.disabled = selectedBulk.size===0;
            if(headerBulk) headerBulk.disabled = selectedBulk.size===0;
            if(footDownload) footDownload.disabled = names.length===0;
            if(headerDownload) headerDownload.disabled = names.length===0;
            const headerWhatsApp = document.getElementById('footerWhatsAppHeaderBtn');
            if(headerWhatsApp) headerWhatsApp.disabled = names.length===0;
            // enable/disable header non-booked download button
            const headerNonBooked = document.getElementById('footerDownloadNonBookedHeaderBtn');
            const unbookedCount = allStudentsData.filter(s=>!bookings[s.nama]).length;
            if(headerNonBooked) headerNonBooked.disabled = unbookedCount===0;
            updateSelectAllCheckbox(); 
        }

        function toggleBulkSelect(name,checked){ if(checked) selectedBulk.add(name); else selectedBulk.delete(name); const topBulk = document.getElementById('bulkDeleteBtn'); const footBulk = document.getElementById('footerBulkDeleteBtn'); const headerBulk = document.getElementById('footerBulkDeleteHeaderBtn'); if(topBulk) topBulk.disabled = selectedBulk.size===0; if(footBulk) footBulk.disabled = selectedBulk.size===0; if(headerBulk) headerBulk.disabled = selectedBulk.size===0; updateSelectAllCheckbox(); }
        function toggleSelectAll(checked){ const names=Object.keys(bookings); if(checked) names.forEach(n=>selectedBulk.add(n)); else selectedBulk.clear(); updateBookedList(); const footBulk = document.getElementById('footerBulkDeleteBtn'); const headerBulk = document.getElementById('footerBulkDeleteHeaderBtn'); if(footBulk) footBulk.disabled = selectedBulk.size===0; if(headerBulk) headerBulk.disabled = selectedBulk.size===0; }
        function updateSelectAllCheckbox(){ const cb=document.getElementById('selectAllCheckbox'); if(!cb) return; const names=Object.keys(bookings); cb.checked = names.length>0 && selectedBulk.size===names.length; }

        function downloadSenarai(){ 
            const names=Object.keys(bookings); 
            if(names.length===0){ showMessage('Tiada tempahan','warning'); return; } 
            const header=document.getElementById('journeyHeader').innerText.trim(); 
            const now = new Date();
            
            // Format timestamp for logging: yyyymmdd_hhmmss
            const yyyy = now.getFullYear();
            const MM = String(now.getMonth() + 1).padStart(2,'0');
            const dd = String(now.getDate()).padStart(2,'0');
            const HH = String(now.getHours()).padStart(2,'0');
            const mm = String(now.getMinutes()).padStart(2,'0');
            const ss = String(now.getSeconds()).padStart(2,'0');
            const timestamp = `${yyyy}${MM}${dd}_${HH}${mm}${ss}`;
            
            // Determine bus assignment depending on segregation setting
            let bus1final = [];
            let bus2final = [];
            if(busSegregationEnabled){
                const lelaki = names.filter(n => {
                    const student = allStudentsData.find(s => s.nama === n);
                    return student?.jantina === 'LELAKI';
                });
                const perempuan = names.filter(n => {
                    const student = allStudentsData.find(s => s.nama === n);
                    return student?.jantina === 'PEREMPUAN';
                });

                // Fill Bus 1 with Lelaki, overflow to Bus 2
                const bus1 = lelaki.slice(0, BUS_CAPACITY);
                const lelakiremainder = lelaki.slice(BUS_CAPACITY);

                // Fill Bus 2 with Perempuan, plus any Lelaki overflow if space available
                let bus2 = perempuan.slice(0, BUS_CAPACITY - lelakiremainder.length);
                bus2 = bus2.concat(lelakiremainder.slice(0, BUS_CAPACITY - bus2.length));

                // Any remaining overflow goes to Bus 1 if space
                const perempuanoverflow = perempuan.slice(BUS_CAPACITY - lelakiremainder.length);
                const bus1overflow = perempuanoverflow.slice(0, BUS_CAPACITY - bus1.length);
                bus1final = bus1.concat(bus1overflow);
                bus2final = bus2;
            } else {
                // Sequential fill (no segregation): fill Bus 1 then Bus 2
                bus1final = names.slice(0, BUS_CAPACITY);
                bus2final = names.slice(BUS_CAPACITY, BUS_CAPACITY * busCount);
            }
            
            let content='Tempahan Bas Pulang Bermalam\n';
            content+=`\n${header}\n`;
            content+=`\nJumlah Pelajar: ${names.length}\n`;
            
            if(bus1final.length){ 
                content+=`\n--- BAS 1 (${bus1final.length}/${BUS_CAPACITY}) ---\n`;
                bus1final.forEach((n,i)=>{ 
                    const student = allStudentsData.find(s=>s.nama===n);
                    const tingkat = student?.tingkatan || '?';
                    const fFormat = `F${tingkat}`;
                    content+=`${i+1}. ${formatName(n)} (${fFormat})\n`;
                }); 
            }
            if(bus2final.length){ 
                content+=`\n--- BAS 2 (${bus2final.length}/${BUS_CAPACITY}) ---\n`;
                bus2final.forEach((n,i)=>{ 
                    const student = allStudentsData.find(s=>s.nama===n);
                    const tingkat = student?.tingkatan || '?';
                    const fFormat = `F${tingkat}`;
                    content+=`${i+1}. ${formatName(n)} (${fFormat})\n`;
                }); 
            }
            
            content+=`\n---\n${timestamp}`;
            
            const a=document.createElement('a'); 
            a.href='data:text/plain;charset=utf-8,'+encodeURIComponent(content); 
            a.download=`Senarai_Tempahan_Bas_${timestamp}.txt`;
            document.body.appendChild(a); 
            a.click(); 
            a.remove(); 
            showMessage('Dimuat turun','success'); 
        }

        function downloadNonBooked(){
            // names that did NOT book
            const unbooked = allStudentsData.filter(s => !bookings[s.nama]);
            if(unbooked.length===0){ showMessage('Tiada pelajar yang belum menempah','warning'); return; }
            const header = document.getElementById('journeyHeader').innerText.trim();
            const now = new Date();
            const yyyy = now.getFullYear();
            const MM = String(now.getMonth() + 1).padStart(2,'0');
            const dd = String(now.getDate()).padStart(2,'0');
            const HH = String(now.getHours()).padStart(2,'0');
            const mm = String(now.getMinutes()).padStart(2,'0');
            const ss = String(now.getSeconds()).padStart(2,'0');
            const timestamp = `${yyyy}${MM}${dd}_${HH}${mm}${ss}`;
            let content = 'Senarai Pelajar Tidak Menempah\n';
            content += `\n${header}\n`;
            content += `\nJumlah Tidak Menempah: ${unbooked.length}\n`;
            unbooked.forEach((s,i)=>{
                const tingkat = s.tingkatan || '?';
                const fFormat = 'F' + tingkat;
                content += `${i+1}. ${formatName(s.nama)} (${fFormat})\n`;
            });
            content += `\n---\n${timestamp}`;
            const a=document.createElement('a');
            a.href='data:text/plain;charset=utf-8,'+encodeURIComponent(content);
            a.download = `Senarai_Tidak_Tempah_${timestamp}.txt`;
            document.body.appendChild(a); a.click(); a.remove(); showMessage('Dimuat turun','success');
        }

        function exportWhatsAppBooked(){
            const names = Object.keys(bookings);
            if(names.length===0){ showMessage('Tiada tempahan','warning'); return; }
            const header = document.getElementById('journeyHeader').innerText.trim();

            // Determine bus assignment depending on segregation setting (same logic as downloads)
            let bus1final = [];
            let bus2final = [];
            if(busSegregationEnabled){
                const lelaki = names.filter(n => { const student = allStudentsData.find(s => s.nama === n); return student?.jantina === 'LELAKI'; });
                const perempuan = names.filter(n => { const student = allStudentsData.find(s => s.nama === n); return student?.jantina === 'PEREMPUAN'; });

                const bus1 = lelaki.slice(0, BUS_CAPACITY);
                const lelakiremainder = lelaki.slice(BUS_CAPACITY);

                let bus2 = perempuan.slice(0, BUS_CAPACITY - lelakiremainder.length);
                bus2 = bus2.concat(lelakiremainder.slice(0, BUS_CAPACITY - bus2.length));

                const perempuanoverflow = perempuan.slice(BUS_CAPACITY - lelakiremainder.length);
                const bus1overflow = perempuanoverflow.slice(0, BUS_CAPACITY - bus1.length);
                bus1final = bus1.concat(bus1overflow);
                bus2final = bus2;
            } else {
                bus1final = names.slice(0, BUS_CAPACITY);
                bus2final = names.slice(BUS_CAPACITY, BUS_CAPACITY * busCount);
            }

            let content = 'Tempahan Bas Pulang Bermalam\n';
            content += `\n${header}\n`;
            content += `\nJumlah Pelajar: ${names.length}\n`;

            if(bus1final.length){
                content += `\n--- BAS 1 (${bus1final.length}/${BUS_CAPACITY}) ---\n`;
                bus1final.forEach((n,i)=>{
                    const student = allStudentsData.find(s=>s.nama===n);
                    const tingkat = student?.tingkatan || '?';
                    const fFormat = 'F' + tingkat;
                    content += `${i+1}. ${formatName(n)} (${fFormat})\n`;
                });
            }
            if(bus2final.length){
                content += `\n--- BAS 2 (${bus2final.length}/${BUS_CAPACITY}) ---\n`;
                bus2final.forEach((n,i)=>{
                    const student = allStudentsData.find(s=>s.nama===n);
                    const tingkat = student?.tingkatan || '?';
                    const fFormat = 'F' + tingkat;
                    content += `${i+1}. ${formatName(n)} (${fFormat})\n`;
                });
            }

            content += `\n---\n`;

            // Try copying to clipboard, then open WhatsApp Web with encoded message as fallback/extra convenience
            const waUrl = 'https://wa.me/?text=' + encodeURIComponent(content);
            if(navigator.clipboard && navigator.clipboard.writeText){
                navigator.clipboard.writeText(content).then(()=>{
                    showMessage('Disalin ke papan klip — membuka WhatsApp...','success');
                    window.open(waUrl, '_blank');
                }).catch(()=>{
                    // if clipboard fails, still open WhatsApp web
                    window.open(waUrl, '_blank');
                    showMessage('Buka WhatsApp...','info');
                });
            } else {
                window.open(waUrl, '_blank');
                showMessage('Buka WhatsApp...','info');
            }
        }

        function openAdminModalForBulkDelete(){
            if (selectedBulk.size === 0) return;
            pendingDeleteList = Array.from(selectedBulk);
            // If admin already logged in, skip password modal and perform deletion after confirmation
            if (isAdmin) {
                const cnt = pendingDeleteList.length;
                if (!confirm(`Padam ${cnt} tempahan terpilih?`)) return;
                deleteAfterAuth();
                return;
            }
            // Show modal with select all option for non-admin
            const modalBody = document.getElementById('adminModalBody');
            document.getElementById('adminPassword').value = '';
            modalBody.innerHTML = '<label class="form-label small">Pilih semua:</label><div class="form-check"><input id="adminDeleteSelectAll" type="checkbox" class="form-check-input" onchange="toggleSelectAllInDeleteModal(this.checked)"><label class="form-check-label small ms-1">Pilih Semua</label></div><br><label class="form-label small">Kata Laluan Admin:</label><input id="adminPassword" class="form-control form-control-sm" type="password">';
            document.getElementById('adminModalTitle').textContent = 'Padam Tempahan';
            document.getElementById('adminModalFooter').innerHTML = '<button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Batal</button><button class="btn btn-danger btn-sm" onclick="deleteAfterAuth()">Padam</button>';
            new bootstrap.Modal(document.getElementById('adminModal')).show();
        }

        function toggleSelectAllInDeleteModal(checked){
            if(checked){ selectedBulk.clear(); Object.keys(bookings).forEach(n=>selectedBulk.add(n)); } else { selectedBulk.clear(); }
        }
        function deleteAfterAuth(){ if(!isAdmin){ const p=document.getElementById('adminPassword').value; if(p!==SECRET_PASS){ showMessage('Kata laluan salah','danger'); return; } } if(pendingDeleteList.length>0){ let c=0; pendingDeleteList.forEach(n=>{ if(bookings[n]){ delete bookings[n]; c++; } }); saveBookings(); selectedBulk.clear(); pendingDeleteList=[]; updateBookedList(); showMessage(`${c} tempahan dipadam`,'success'); bootstrap.Modal.getInstance(document.getElementById('adminModal')).hide(); return; } showMessage('Tiada yang dipadam','info'); }

        function openAdminModalForEdit(){
            // populate modal inputs from saved journeyHeader if present
            const stored = localStorage.getItem('journeyHeader');
            let direction = '';
            let dateTimeValue = '';
            if(stored){ try{ const d = JSON.parse(stored); const text = d.text||''; const date = d.date||''; if(text.includes('ke MTSD')){ direction='2'; } else { direction='1'; } dateTimeValue = date; }catch(e){} }
            document.getElementById('editJourneyDirection').value = direction;
            document.getElementById('editJourneyDateTime').value = dateTimeValue;
            updateJourneyDestinationOptions();
            new bootstrap.Modal(document.getElementById('editJourneyModal')).show();
        }

        function updateJourneyDestinationOptions(){ }

        function formatDateTimeDisplay(isoDateTime){
            if(!isoDateTime) return '';
            const dt = new Date(isoDateTime);
            const days = ['Minggu','Isnin','Selasa','Rabu','Khamis','Jumaat','Sabtu'];
            const months = ['Jan','Feb','Mac','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Dis'];
            const day = days[dt.getDay()];
            const date = dt.getDate();
            const month = months[dt.getMonth()];
            const year = dt.getFullYear();
            let hours = dt.getHours();
            const mins = String(dt.getMinutes()).padStart(2,'0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;
            const hoursStr = String(hours).padStart(2,'0');
            return `${day}, ${date} ${month} ${year} ${hoursStr}:${mins} ${ampm}`;
        }

        function openAdminModalForEditConfirm(){
            const direction = document.getElementById('editJourneyDirection').value;
            const dateTime = document.getElementById('editJourneyDateTime').value;
            if(!direction){ showMessage('Sila pilih arah perjalanan','danger'); return; }
            if(!dateTime){ showMessage('Sila pilih tarikh dan masa','danger'); return; }
            let text = direction === '1' ? 'Perjalanan dari MTSD ke Sungai Petani/Gurun/Alor Setar' : 'Perjalanan dari Sungai Petani/Gurun/Alor Setar ke MTSD';
            const dateDisplay = formatDateTimeDisplay(dateTime);
            // If admin logged in, save directly
            if(isAdmin){ saveJourneyHeader(text,dateDisplay); bootstrap.Modal.getInstance(document.getElementById('editJourneyModal')).hide(); showMessage('Perjalanan dikemaskini','success'); return; }
            // require admin auth: store pending and show admin modal
            pendingJourneyEdit = { text, date: dateDisplay };
            // hide edit modal while asking for admin password
            const editModalEl = document.getElementById('editJourneyModal');
            const editModalInst = bootstrap.Modal.getInstance(editModalEl);
            if(editModalInst) editModalInst.hide();
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminModalTitle').textContent = 'Pengesahan untuk Kemaskini';
            document.getElementById('adminModalBody').innerHTML = '<label class="form-label small">Kata Laluan Admin:</label><input id="adminPassword" class="form-control form-control-sm" type="password">';
            document.getElementById('adminModalFooter').innerHTML = '<button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Batal</button><button class="btn btn-primary btn-sm" onclick="saveJourneyEditAfterAuth()">Sahkan & Simpan</button>';
            new bootstrap.Modal(document.getElementById('adminModal')).show();
        }

        function saveJourneyEditAfterAuth(){
            if(!isAdmin){ const p = document.getElementById('adminPassword').value; if(p!==SECRET_PASS){ showMessage('Kata laluan salah','danger'); return; } isAdmin = true; updateAdminUI(); }
            if(pendingJourneyEdit){ saveJourneyHeader(pendingJourneyEdit.text,pendingJourneyEdit.date); pendingJourneyEdit = null; saveBookings(); bootstrap.Modal.getInstance(document.getElementById('adminModal')).hide(); bootstrap.Modal.getInstance(document.getElementById('editJourneyModal')).hide(); showMessage('Perjalanan dikemaskini','success'); }
        }

        function openAdminImportModal(){
            document.getElementById('adminImportPassword').value = '';
            document.getElementById('csvImportFile').value = '';
            document.getElementById('importPreviewSection').style.display = 'none';
            document.getElementById('confirmImportBtn').disabled = true;
            const pwContainer = document.getElementById('adminImportPasswordContainer');
            const loggedNote = document.getElementById('adminImportLoggedInNotice');
            if(isAdmin){
                if(pwContainer) pwContainer.style.display = 'none';
                if(loggedNote) loggedNote.style.display = 'block';
            } else {
                if(pwContainer) pwContainer.style.display = 'block';
                if(loggedNote) loggedNote.style.display = 'none';
            }
            new bootstrap.Modal(document.getElementById('adminImportModal')).show();
        }
        function previewImportCSV(){ const f=document.getElementById('csvImportFile').files[0]; if(!f) return; const r=new FileReader(); r.onload=e=>{ const csv=e.target.result; const lines=csv.split(/\r?\n/).filter(Boolean); if(lines.length<2){ document.getElementById('importMessage').textContent='CSV tidak sah'; document.getElementById('importMessage').className='alert alert-danger'; document.getElementById('importMessage').style.display='block'; return; } const headers=lines[0].split(',').map(h=>h.trim().toUpperCase()); const rows=[]; for(let i=1;i<lines.length;i++){ const vals=lines[i].split(','); const obj={}; headers.forEach((h,idx)=> obj[h]= (vals[idx]||'').trim()); rows.push(obj); } // preview
            const head=document.getElementById('importPreviewHead'); const body=document.getElementById('importPreviewBody'); head.innerHTML=''; body.innerHTML=''; const tr=document.createElement('tr'); headers.forEach(h=>{ const th=document.createElement('th'); th.textContent=h; tr.appendChild(th); }); head.appendChild(tr); rows.slice(0,5).forEach(rw=>{ const tr2=document.createElement('tr'); headers.forEach(h=>{ const td=document.createElement('td'); td.textContent = rw[h]||''; tr2.appendChild(td); }); body.appendChild(tr2); }); document.getElementById('importRowCount').textContent=`Jumlah baris: ${rows.length}`; document.getElementById('importPreviewSection').style.display='block'; document.getElementById('confirmImportBtn').disabled=false; document.getElementById('importMessage').style.display='none'; }; r.readAsText(f,'utf-8'); }

        function confirmImportStudents(){ if(!isAdmin){ const p=document.getElementById('adminImportPassword').value; if(p!==SECRET_PASS){ document.getElementById('importMessage').textContent='Kata laluan salah'; document.getElementById('importMessage').className='alert alert-danger'; document.getElementById('importMessage').style.display='block'; return; } } const f=document.getElementById('csvImportFile').files[0]; if(!f) return; const r=new FileReader(); r.onload=e=>{ const csv=e.target.result; const lines=csv.split(/\r?\n/).filter(Boolean); const headers=lines[0].split(',').map(h=>h.trim().toUpperCase()); const rows=[]; for(let i=1;i<lines.length;i++){ const vals=lines[i].split(','); const obj={}; headers.forEach((h,idx)=> obj[h]= (vals[idx]||'').trim()); rows.push(obj); } allStudentsData = rows.map(row=>({ nama: row['NAMA']||'', jantina: row['JANTINA']||'', tingkatan: row['TINGKATAN']||'' })); saveStudentsDataToStorage(); bookings={}; saveBookings(); selectedBulk.clear(); updateStudentsByFilter(); updateBookedList(); bootstrap.Modal.getInstance(document.getElementById('adminImportModal')).hide(); showMessage(`Diimport ${allStudentsData.length} pelajar`,'success'); }; r.readAsText(f,'utf-8'); }

        document.addEventListener('DOMContentLoaded', async ()=>{ loadBookings(); loadJourneyHeader(); await loadStudentsData(); loadSettings(); updateAdminUI(); updateStudentList(); updateBookedList(); });
    </script>
</body>
</html>